# coding=utf-8
# Copyright 2021 The Google Research Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""Training and evaluation in the online mode."""
from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import collections
import os
import time
from typing import Any

from absl import logging

import gin
import numpy as np
import tensorflow.compat.v1 as tf
from brac import dataset
from brac import policies
from brac import train_eval_utils
from brac import utils
from mbbl.env import env_register
import random
from tf_agents.environments import tf_py_environment
from tf_agents.environments import py_environment
from tf_agents.environments import tf_environment
from tf_agents.specs import array_spec
from tf_agents.trajectories import time_step as ts
from tf_agents.environments import utils
from gym.spaces import box


class env(py_environment.PyEnvironment):

    def get_info(self) -> Any:
        pass

    def get_state(self) -> Any:
        pass

    def set_state(self, state: Any) -> None:
        pass

    def __init__(self, env_name, rand_seed, misc_info):
        self._env_name = env_name
        self._seed = rand_seed
        self._npr = np.random.RandomState(self._seed)
        self._misc_info = misc_info
        self._env_info = env_register.get_env_info(self._env_name)
        self.dimension = 20
        # self._action_spec = array_spec.BoundedArraySpec(
        #     shape=(), dtype=np.int32, minimum=-1, maximum=1, name='action')
        # self._observation_spec = array_spec.BoundedArraySpec(
        #     shape=(), dtype=np.int32, minimum=-100, maximum=100, name='observation')
        self.action_space = box.Box(low=-1.0, high=1.0, shape=(self.dimension,), dtype=np.float32)
        self.observation_space = box.Box(low=-np.inf, high=np.inf, shape=(self.dimension,), dtype=np.float32)
        self.P = 0.5 * np.eye(self.dimension) + np.diag(0.2 * np.ones(self.dimension-1),k=1) + np.diag(0.2 * np.ones(self.dimension-1),k=-1)
        self.Q = 0.5 * np.eye(self.dimension) + np.diag(0.1 * np.ones(self.dimension-1),k=1) + np.diag(0.1 * np.ones(self.dimension-1),k=-1)
        self.mean = np.zeros(self.dimension)
        self.identity = np.eye(self.dimension)
#         self.transition = np.array([[ 6.88119161e-03, 5.01101257e-01, 2.02731242e-01,-1.29800824e-03,
#   -3.83302519e-03, 1.68055337e-03,-8.26905782e-05, 4.31176101e-03,
#   1.51513914e-03,-1.95999960e-03, 4.55979083e-04, 9.86125744e-04,
#   1.28456443e-03,-1.45542092e-03, 3.39795751e-03,-2.71581162e-03,
#   1.42045308e-03,-8.67515925e-04,-1.64149157e-03, 1.94641713e-03,
#   -8.20885681e-04, 4.15673492e-02,-6.62542949e-03,-1.79146741e-02,
#   7.75977919e-03,-3.92894992e-03,-1.61202007e-03, 2.44807152e-03,
#   -1.03214107e-04, 6.96431211e-04,-1.45081647e-03,-5.37246419e-03,
#   8.01622359e-03, 1.16106898e-03,-4.43763192e-03,-1.40634174e-03,
#   -5.54861474e-03,-1.30372747e-03, 1.50621359e-03,-4.89502257e-03,
#   -1.22291266e-03],
#  [ 2.56920104e-03, 1.98424350e-01, 5.03686439e-01, 1.97131618e-01,
#   -4.16762807e-04, 1.75876725e-03,-4.08657207e-03, 3.33169074e-03,
#   -1.54463502e-03, 3.41656990e-03,-6.11726582e-03, 6.58835746e-03,
#   -1.09723636e-03,-5.20529124e-04,-2.62755307e-03, 2.52393610e-03,
#   4.96781523e-03, 1.45410793e-04,-1.93613523e-03, 4.14575848e-03,
#   -4.30929908e-04,-5.34904657e-03, 3.36345770e-02,-4.94848993e-03,
#   -1.36639885e-02,-2.12178966e-03,-2.09631503e-03,-2.50660635e-03,
#   -4.65207856e-03, 1.82523170e-03, 2.55444891e-03, 4.36778990e-03,
#   1.30924567e-03,-3.44215169e-03,-5.14140972e-03, 2.92863750e-03,
#   2.64852239e-04,-3.48953551e-03, 5.24246084e-03,-1.55765297e-03,
#   -1.37706776e-03],
#  [ 5.18014717e-03,-2.16532274e-03, 2.02070470e-01, 4.92769257e-01,
#   2.04814491e-01,-3.88612868e-03,-1.68331217e-04, 4.76866340e-03,
#   -1.15222666e-03, 3.09242936e-03,-4.55124442e-03, 1.34924509e-03,
#   6.41843952e-05, 2.71298575e-04,-2.40355613e-03, 7.00721457e-03,
#   -7.89492170e-03, 2.39210846e-03,-3.96056415e-03, 1.99238121e-03,
#   -3.33179273e-04,-2.07468897e-02, 2.09294736e-04, 4.38062929e-02,
#   -2.91505535e-03,-1.35676905e-02, 1.61916751e-03,-3.71204491e-03,
#   -9.84528244e-03, 1.38747836e-03, 4.11836415e-03, 9.48261302e-05,
#   1.88340535e-03,-3.24582020e-03, 4.21015507e-03,-2.71762378e-03,
#   2.68379178e-03, 1.59894221e-03, 9.19856872e-04, 4.59102258e-04,
#   2.34718584e-03],
#  [ 8.35906340e-03,-3.67904804e-03, 3.08741120e-03, 1.99830713e-01,
#   5.08173806e-01, 1.93054816e-01, 1.81319671e-03,-5.45526763e-03,
#   2.87736403e-03, 2.54673739e-03,-4.72741963e-04,-5.12062558e-04,
#   1.38239673e-03,-2.51178047e-03, 6.79779266e-03,-2.63677290e-03,
#   8.09970021e-04,-1.46234673e-03, 5.45160336e-04, 4.57318102e-04,
#   9.63330919e-05,-3.85970661e-05,-1.27576768e-02,-4.41915861e-03,
#   3.43664252e-02,-4.72264199e-04,-1.69078430e-02, 4.32949828e-03,
#   4.44603994e-03,-8.62025601e-04,-7.46237393e-04,-3.28991759e-03,
#   1.70289998e-06,-8.45921668e-03,-3.67017722e-04, 2.21335658e-03,
#   -4.97113059e-03, 1.53370695e-03, 5.52655693e-03, 2.81686717e-04,
#   2.53269527e-03],
#  [ 2.98011820e-04,-4.75900298e-03,-1.20169406e-03, 4.44160278e-03,
#   1.99043941e-01, 5.04143161e-01, 1.98617718e-01, 1.98449110e-03,
#   -1.28351765e-03,-1.28559497e-03,-7.81638605e-04, 9.92745723e-03,
#   -3.47171679e-03,-4.11591108e-03, 4.54289323e-03,-2.89309058e-04,
#   -1.07522099e-03,-2.41259188e-03,-4.41891642e-03, 3.03663183e-03,
#   -1.13525527e-03, 3.22669530e-03, 3.37396995e-03,-1.35634125e-02,
#   -2.53135963e-03, 3.51518569e-02, 1.39119682e-03,-8.69059511e-03,
#   5.46596481e-03, 3.81072590e-04, 1.82543070e-04, 3.68396797e-04,
#   -3.28101424e-04,-3.36198985e-03,-3.76407136e-03, 6.54917761e-03,
#   1.96095320e-03,-9.00104849e-03,-4.31701605e-04, 1.89880194e-03,
#   -4.16763329e-03],
#  [ 3.22874824e-03,-4.34901067e-03, 1.00488348e-03,-2.17397219e-03,
#   -1.04495295e-03, 2.05001077e-01, 4.98723833e-01, 2.02891219e-01,
#   1.37033207e-03, 3.45599554e-04,-4.75487396e-04, 4.74974168e-04,
#   -1.17606915e-03, 1.08081686e-04, 4.32819119e-03, 9.41898480e-04,
#   8.87145398e-05, 3.34204342e-04,-3.82109122e-03, 1.18225321e-03,
#   -3.25076877e-04,-5.67666972e-03, 2.74907301e-03, 3.16946520e-04,
#   -1.46642459e-02,-5.51852979e-03, 3.65998241e-02,-1.13382402e-03,
#   -8.06907935e-03,-3.91682359e-04, 9.39638264e-04, 3.65244965e-03,
#   6.02999821e-03, 5.31089085e-03, 7.34193208e-04, 1.00916424e-03,
#   5.80220003e-03,-1.85353216e-03, 5.66082809e-04,-8.57420483e-05,
#   -4.42065767e-03],
#  [ 4.00083892e-05,-5.68297723e-03, 1.30403301e-03,-8.42699496e-04,
#   1.74820066e-03, 2.04934487e-03, 1.95910119e-01, 4.97888545e-01,
#   2.02842508e-01, 1.15762329e-03,-9.29109190e-04, 6.26157567e-03,
#   -2.82936067e-03, 5.82463228e-04, 1.22996513e-03, 3.96204739e-04,
#   1.75418670e-03, 1.74711677e-03,-1.44296775e-03, 1.06769475e-03,
#   1.81707704e-03, 5.55791455e-03, 8.31088019e-04, 3.33902003e-03,
#   -2.61641287e-03,-1.19775949e-02,-1.41425070e-03, 3.72258227e-02,
#   1.73270269e-04,-1.04889917e-02,-4.97661511e-03, 3.13957206e-04,
#   3.24699908e-03,-7.24322107e-04,-3.55673625e-03,-5.75907072e-03,
#   5.63962554e-03,-3.20600356e-03, 1.96705178e-03, 7.30022775e-04,
#   1.17184533e-03],
#  [ 1.62039562e-04,-1.81360884e-03,-2.91044700e-03, 4.64429944e-03,
#   -1.97919181e-03,-1.22218308e-03,-2.30948019e-03, 1.99825956e-01,
#   4.99034231e-01, 2.04161641e-01, 1.71180386e-03,-1.44829612e-03,
#   5.76362679e-03,-5.95842629e-03,-9.43052887e-05, 3.67777583e-03,
#   2.22939032e-03, 3.10673798e-03,-1.50007180e-03, 7.24238364e-04,
#   3.88244724e-03, 1.75580510e-03,-6.57777128e-04,-2.35110163e-03,
#   -4.07491664e-03, 3.32237457e-03,-1.19702505e-02,-1.43725390e-03,
#   3.74101125e-02,-8.64532226e-03,-1.11487708e-02, 4.29416466e-03,
#   2.20464244e-03,-1.89618506e-03, 3.12533449e-03,-2.09241668e-03,
#   8.82901550e-04, 1.31830511e-03,-2.20441211e-03, 1.98858092e-03,
#   -1.92500270e-03],
#  [ 1.72705753e-03,-3.82746243e-03,-6.99975093e-04, 2.29835940e-03,
#   -3.02250121e-04,-5.33358184e-03, 3.54173513e-03,-3.51301257e-03,
#   1.99296771e-01, 5.00086008e-01, 2.05627354e-01,-3.74851182e-03,
#   5.03222865e-03, 1.78709972e-03, 1.43342698e-03, 3.64816839e-04,
#   -4.38101098e-03, 1.70360793e-03, 2.99794688e-03,-3.58240879e-03,
#   1.08993056e-03,-4.78998316e-03,-1.73545347e-03, 6.21660238e-04,
#   7.45889192e-04,-2.38729540e-03, 1.68171330e-04,-1.48695266e-02,
#   2.51963580e-03, 3.46279462e-02,-2.98705036e-03,-1.38126255e-02,
#   -2.49121070e-03, 6.01933969e-03, 1.50332396e-04, 3.14414468e-03,
#   -1.55752174e-03,-2.48814530e-04,-6.05037518e-03, 7.70074944e-04,
#   -3.61833143e-03],
#  [ 2.88639191e-03,-1.57199392e-03,-2.25282075e-04,-6.11084306e-03,
#   5.30987556e-03,-4.49555877e-03, 2.20416883e-03, 3.14032277e-03,
#   -1.25609715e-03, 1.95967947e-01, 4.98579903e-01, 2.00878473e-01,
#   -4.78911079e-03, 1.59484284e-03, 1.36746459e-03, 1.21001356e-03,
#   -3.19415699e-03, 3.62049225e-03, 4.33188783e-03, 5.39288545e-04,
#   -4.07363285e-03,-5.96766070e-03,-2.38274273e-03, 6.88273112e-04,
#   6.46743618e-03,-6.13031090e-04, 1.09610537e-03,-1.96969573e-05,
#   -1.08693980e-02, 4.12137107e-03, 3.09990077e-02, 9.73788670e-03,
#   -1.45058189e-02, 1.03288803e-03, 2.05158078e-03, 5.92588966e-03,
#   4.63973228e-03, 2.49360750e-04,-3.58212561e-04, 1.49784375e-03,
#   -3.95809315e-03],
#  [ 2.60400793e-03, 3.97176318e-03,-4.44553879e-03, 3.40608962e-03,
#   -4.65268915e-03, 3.43958445e-03,-5.53573705e-03, 4.05177384e-03,
#   -3.02579691e-03,-2.59075460e-03, 1.99577777e-01, 4.98494558e-01,
#   2.03241746e-01,-4.72476871e-03,-3.88296589e-03, 5.17216039e-03,
#   -6.21336631e-03, 6.94781277e-03,-3.20180696e-03, 2.12748088e-03,
#   9.58257239e-04, 2.65400985e-04,-2.85488508e-03, 1.46998854e-03,
#   -2.31529688e-04,-7.92779797e-04,-1.62026273e-03,-1.59341648e-03,
#   5.30236142e-03,-1.05189356e-02,-5.12659564e-03, 3.39263490e-02,
#   -9.16663618e-04,-1.26295187e-02, 2.63617518e-04, 4.10296662e-05,
#   6.41283034e-04,-3.59041583e-03, 1.30195121e-03, 6.73354149e-05,
#   1.56253397e-03],
#  [ 5.19868118e-03, 1.37419871e-05,-1.10138115e-03, 3.90869085e-03,
#   -3.62725747e-03, 4.29695808e-03,-2.46740912e-03, 1.45372003e-03,
#   -1.75392359e-03,-2.48469364e-03, 3.31812319e-04, 1.99014837e-01,
#   4.97631056e-01, 2.02564054e-01,-1.62947347e-04,-1.50059956e-03,
#   -1.83828051e-03, 6.86520517e-03,-4.59129916e-03, 1.18875334e-03,
#   4.58605173e-05, 4.39816032e-03,-1.61961636e-03, 1.90183742e-03,
#   6.85313124e-04, 5.25767015e-03,-4.14934919e-03, 2.55421537e-03,
#   -2.55196879e-03, 1.41621278e-03,-1.42720786e-02,-5.41578104e-03,
#   4.15209923e-02,-9.77692351e-03,-1.39309438e-02, 6.05348854e-03,
#   -7.72048750e-03,-2.72241364e-03,-5.09145281e-03, 2.66487060e-04,
#   6.50386228e-03],
#  [ 9.82169238e-04, 5.35929535e-03,-5.68208949e-03, 1.12820138e-02,
#   -7.87085825e-03, 3.98066998e-03,-1.00918259e-03, 2.18261805e-04,
#   2.78850464e-03, 1.04057720e-03,-4.80456845e-03, 4.39684734e-03,
#   1.94084798e-01, 5.02258534e-01, 1.94474102e-01, 3.88704133e-03,
#   -2.06477710e-03, 3.23922033e-03,-8.00832186e-04, 4.73542501e-04,
#   -2.69909987e-03, 1.98029873e-03, 5.39304075e-04, 5.52606313e-03,
#   -4.21944649e-03,-2.01906144e-03,-4.66708007e-03, 7.60575841e-03,
#   -3.94540367e-03,-3.72942853e-03,-6.58630773e-04,-1.47551800e-02,
#   2.47537118e-03, 3.87968738e-02,-6.03872410e-03,-1.11777899e-02,
#   -2.57450211e-03,-1.25220119e-04, 3.59085009e-03, 1.40898119e-03,
#   5.10592532e-03],
#  [-9.03954073e-04, 4.30537383e-03,-7.94265417e-03, 8.81805459e-04,
#   2.61385482e-03,-6.48248767e-03, 3.25626597e-03,-4.23169014e-03,
#   8.58467051e-03,-7.81639967e-03, 1.08086077e-03,-9.95348943e-04,
#   2.34537007e-03, 2.00402769e-01, 5.00800673e-01, 1.99094755e-01,
#   2.15644233e-03, 1.53750790e-03,-2.13711091e-03, 2.26479456e-04,
#   1.18645616e-03, 4.10016059e-03, 7.35014192e-03,-5.47955805e-04,
#   1.66022011e-03, 7.86582404e-03,-3.64448059e-03,-1.70991651e-03,
#   3.87016778e-05,-9.83661824e-04, 2.42998478e-03, 1.68024569e-03,
#   -1.61128574e-02,-1.74515461e-03, 3.51872619e-02,-4.03099059e-03,
#   -1.71766895e-02,-4.63414421e-03,-1.05895793e-03, 4.01845397e-03,
#   -2.09380410e-03],
#  [ 2.43015952e-03,-3.85687184e-03,-1.02037005e-03, 2.81949119e-03,
#   -1.90124456e-03, 1.56616087e-03, 1.57765915e-03,-3.34386341e-03,
#   2.59960965e-03,-3.25988566e-03, 2.88669081e-03,-5.85326599e-03,
#   -1.46220488e-03, 2.22836190e-03, 1.99194914e-01, 4.99603548e-01,
#   1.98943671e-01, 2.90714032e-04, 8.81309715e-03,-6.44663107e-03,
#   -1.65040594e-03,-5.01708474e-04,-5.34651331e-03, 1.18033631e-03,
#   8.03739087e-03, 4.72056146e-03, 1.37758830e-03, 8.63304758e-03,
#   -6.06874113e-03, 3.37712396e-04,-1.73795663e-03,-2.18878424e-04,
#   1.49422270e-03,-1.74286851e-02, 1.61336634e-03, 3.68975534e-02,
#   1.02457866e-03,-1.84623693e-02,-3.06924808e-03, 6.16102016e-03,
#   3.57170963e-03],
#  [ 8.54872977e-04,-4.11867538e-03, 4.43885002e-03, 4.69607968e-04,
#   6.46424590e-04, 7.59950988e-04,-2.76959414e-03, 5.73109365e-03,
#   -1.06623790e-03,-8.02593502e-04, 4.68299741e-03,-3.06168326e-03,
#   -1.14789582e-04,-1.67954660e-03,-1.76918378e-03, 2.01067172e-01,
#   5.04477743e-01, 1.98479181e-01, 9.40526758e-04,-5.21322823e-03,
#   1.38909489e-03,-5.00378246e-03,-4.53910381e-03, 3.28392733e-03,
#   1.92701411e-03, 3.91754575e-03, 1.60067300e-03,-1.89763855e-03,
#   -4.99266779e-05, 2.93219415e-03,-3.63095373e-03,-1.61779331e-03,
#   1.95221344e-03, 3.03470859e-03,-1.18857649e-02,-3.87277847e-04,
#   3.29423218e-02,-1.49392136e-03,-1.35393809e-02, 1.61785018e-03,
#   4.72341481e-03],
#  [ 1.16834057e-03, 2.80418403e-03, 1.25674474e-03,-5.03332514e-03,
#   7.79138971e-03,-8.90311286e-03, 3.92482047e-03, 1.84710146e-03,
#   -6.77230218e-03, 3.56361345e-03, 8.02362988e-04, 1.85411696e-04,
#   -5.90276464e-03, 3.82804854e-03, 3.22522624e-03,-8.92403217e-04,
#   2.05233160e-01, 4.96760715e-01, 1.98198099e-01,-2.24341809e-03,
#   3.78243991e-03,-5.72144178e-03, 1.24276381e-03,-3.20314345e-03,
#   3.53597235e-03,-4.11002208e-04,-4.24467861e-04, 4.46675926e-03,
#   -2.50249543e-03, 5.71487679e-03,-4.18001656e-03,-1.56832514e-03,
#   4.27686831e-04, 5.63456842e-03, 9.37626719e-03,-1.46004530e-02,
#   -6.72191560e-03, 3.80649681e-02, 2.04696451e-04,-1.52685710e-02,
#   3.36608463e-03],
#  [-4.12302614e-03, 3.01542801e-03, 2.06566671e-03,-1.15258833e-03,
#   2.63988136e-03,-5.19751732e-03, 6.30173690e-03,-7.30407485e-03,
#   1.63502782e-03, 3.04166457e-04,-5.45598506e-04, 1.66038779e-03,
#   2.14682255e-03, 1.13010957e-03, 1.82705190e-03,-3.20976083e-03,
#   8.65047507e-04, 2.03107356e-01, 4.98444141e-01, 2.00261051e-01,
#   -1.05957667e-03,-2.55272683e-03, 3.59323397e-04, 6.44719328e-04,
#   -2.89817396e-03, 3.54104484e-03,-4.49774544e-03, 5.44174079e-03,
#   -3.67584331e-03,-3.40804564e-03,-5.40889858e-03,-8.77748957e-04,
#   6.04154950e-04, 9.72151515e-04,-3.77586093e-03,-6.93473993e-04,
#   -1.06055157e-02,-1.18744220e-02, 3.71040843e-02,-5.42037517e-03,
#   -1.26217191e-02],
#  [ 1.82428165e-03, 5.07149664e-03, 5.95698503e-03, 2.65000638e-03,
#   4.56422548e-04,-6.29463742e-03, 1.92055494e-03, 3.31779166e-03,
#   -2.12482557e-03, 8.02867759e-04,-3.56058204e-04,-4.55059515e-03,
#   1.05930986e-03,-1.60918571e-03, 3.52153738e-03,-1.05018018e-02,
#   2.86854220e-03, 2.32215954e-03, 1.96550596e-01, 4.94754936e-01,
#   1.98643634e-01,-5.37416741e-03,-2.45489825e-03,-5.10436481e-03,
#   -2.41524116e-03, 2.06111874e-03,-3.59991474e-03,-4.15673199e-03,
#   7.21076370e-03, 1.35226745e-03,-8.74405565e-04,-2.16756943e-03,
#   1.54553802e-03,-1.03319272e-03,-4.60028975e-03, 1.67680378e-03,
#   -2.74635357e-04,-1.49776437e-02,-2.05499348e-03, 3.46443166e-02,
#   -6.10829310e-03],
#  [ 1.02496469e-03,-4.26381496e-06, 4.36061948e-03,-1.43813772e-03,
#   1.80869619e-03, 1.67340063e-03,-5.48717644e-03, 8.55282733e-03,
#   -3.36608255e-03, 2.22051651e-03,-2.52593875e-03,-4.65121648e-03,
#   2.47254093e-03,-2.23909274e-03, 1.20587752e-03,-4.77374388e-03,
#   2.95228619e-03,-1.41915860e-03,-1.94796556e-03, 1.98903043e-01,
#   5.01438469e-01,-8.51065742e-03,-5.37108387e-04, 5.40172974e-04,
#   -2.62988229e-03, 3.71856538e-03, 5.53729139e-04,-2.88272495e-03,
#   8.41009543e-03,-1.00850694e-02, 7.97493150e-04, 3.97344057e-03,
#   -8.23784611e-04, 1.64935405e-03,-4.81876472e-03, 9.15075828e-04,
#   -3.11917465e-03,-3.12424662e-03,-7.34253497e-03,-8.60932456e-03,
#   5.11859733e-02]])
   
   
        self.transition = np.array([[ 1.15045069e-03, 5.04027851e-01, 1.99725684e-01,-2.41976710e-03,
  -5.19603071e-03, 5.02313353e-03, 1.01694521e-03, 5.53567697e-04,
   2.97820299e-04, 6.75385237e-04, 3.31664648e-03,-7.32968879e-03,
   1.71615164e-03,-2.10653581e-03,-1.26254771e-04, 4.01377799e-03,
   2.32538287e-03,-7.94868165e-03, 1.08616960e-02,-2.77445709e-03,
  -3.78028098e-03, 5.11455318e-02,-5.39091620e-03,-9.30299718e-03,
  -1.28979144e-03,-2.57213230e-03,-2.42853351e-03, 4.29872203e-03,
  -6.80094603e-03, 1.23782232e-03, 1.62259701e-03,-3.64007353e-03,
   6.43541320e-03, 6.06845092e-03, 3.32324456e-03,-2.03317601e-03,
  -4.24619433e-03, 9.06549277e-04, 2.88596610e-03, 5.98171365e-03,
  -2.02003545e-03],
 [-2.48823770e-03, 2.02474780e-01, 4.97625957e-01, 2.03071668e-01,
  -8.12387043e-03, 5.33620370e-03,-3.95609809e-03, 6.04188925e-03,
  -1.23446590e-03,-1.47135189e-03,-4.13729059e-03, 6.22488806e-03,
  -2.79215338e-04,-3.00051976e-03, 4.38221857e-04, 7.65620156e-03,
  -5.16737762e-04,-4.14384037e-03, 3.70119100e-03,-2.39849849e-03,
  -1.65095806e-03,-8.22411936e-03, 3.33399713e-02,-4.02918566e-03,
  -1.71946133e-02,-2.75628407e-03,-5.20656054e-03, 2.63055832e-03,
  -5.34251571e-03, 1.12200114e-04, 2.79446547e-03,-3.67901047e-03,
   7.26659357e-04,-1.28571549e-03,-1.55776529e-03,-1.42280672e-03,
  -2.93172006e-03, 6.05938054e-03,-6.22045635e-03, 3.55262320e-03,
  -2.16907971e-03],
 [-1.47430154e-03, 4.50299846e-03, 2.02349287e-01, 4.97533408e-01,
   1.98320430e-01,-3.05135094e-03,-1.01014913e-03, 6.02987037e-04,
   1.36945223e-03, 3.83172384e-05,-3.06274534e-03, 2.14719661e-03,
   2.12536094e-03,-2.28447092e-03, 4.26594023e-05,-1.71914529e-03,
   3.62286333e-03, 1.31484152e-03,-3.39153912e-03,-1.03540384e-05,
   1.96567554e-03,-8.80312869e-03,-9.24542314e-03, 3.79668732e-02,
  -6.72441690e-03,-1.31664482e-02, 1.12610648e-03, 3.01004727e-04,
  -1.93438274e-03, 1.12398403e-03, 1.75624122e-03,-2.00944924e-03,
   2.73037652e-03,-2.95547710e-03,-2.08008756e-04, 2.19012748e-03,
   3.38483760e-03, 4.78025295e-03,-5.96081377e-03, 1.71965709e-03,
  -2.37277576e-03],
 [ 3.01002772e-03, 1.52140728e-03,-5.80728499e-04, 1.98474982e-01,
   5.01796026e-01, 1.93785629e-01, 1.12683589e-03, 7.89780415e-04,
  -8.37808061e-04, 1.30695543e-03,-4.35204887e-03, 3.66380363e-03,
  -8.69301440e-05, 1.86427454e-03,-2.77409846e-03, 1.65545602e-03,
   3.59055869e-03,-5.24562929e-04,-3.25431381e-03,-8.15634201e-05,
  -2.70998017e-03, 4.07797288e-03,-1.67257929e-02,-3.29600676e-03,
   3.57394277e-02,-6.65556739e-03,-1.17601073e-02,-2.46497648e-03,
   4.08211350e-03, 3.02706954e-04,-4.28478627e-04,-5.60817581e-03,
   3.00560044e-04,-7.68996968e-03, 5.93819839e-03, 6.15845542e-03,
   1.73907315e-03, 2.72731017e-03,-3.67617484e-03,-5.00617890e-03,
  -3.30964903e-03],
 [ 1.31410703e-04, 1.29951373e-03, 7.99690308e-04,-6.51310529e-04,
   2.02121299e-01, 4.95856453e-01, 2.01575222e-01,-5.18166082e-04,
   2.14300952e-03, 5.72525050e-04,-1.82706941e-03,-3.35900169e-05,
  -1.54701933e-03,-4.30472667e-03, 3.61357023e-03,-4.47522480e-04,
  -2.18044743e-03, 4.07989141e-03,-3.03918920e-03,-5.80509363e-03,
   5.43242379e-03, 5.35331322e-03,-3.07540087e-03,-1.44947023e-02,
  -8.17204344e-04, 3.47028957e-02,-3.44302870e-03,-1.71334252e-02,
  -1.86575903e-03, 2.13652733e-03,-1.44603616e-03,-1.07446838e-03,
   4.19651089e-03,-3.22740418e-03, 3.12979743e-03, 9.04040738e-03,
   9.24515043e-03,-1.28235514e-03,-4.47960503e-03,-1.41593890e-04,
  -1.23842876e-03],
 [ 1.93645525e-05, 3.31290950e-03,-8.29531020e-04,-2.20549423e-03,
   2.32903263e-03, 1.97909762e-01, 4.98251789e-01, 1.99521352e-01,
  -2.51227762e-03, 4.71994733e-03, 2.85245837e-03,-5.73033882e-03,
   6.08549241e-03,-6.10003037e-04,-1.32922440e-03,-2.61686636e-03,
   2.07074421e-04, 1.08856371e-03, 9.11755597e-05,-2.70502323e-03,
   2.83147879e-03, 5.76271349e-03,-2.61737228e-03, 2.99744784e-03,
  -1.23864299e-02,-3.24968099e-03, 3.39351677e-02,-7.07464957e-03,
  -1.67680959e-02, 5.85573601e-03,-4.33671474e-03, 4.13036626e-03,
   7.59685208e-04, 3.95507207e-03,-4.39409878e-03, 1.03285293e-03,
   4.52320179e-03, 8.40596725e-04,-1.29849530e-03, 2.49876800e-03,
  -1.13157390e-03],
 [ 8.44692846e-03, 1.22976589e-03, 1.13702880e-03,-8.13296289e-04,
  -5.91446392e-03, 6.24523533e-03, 1.97122860e-01, 4.95021866e-01,
   1.96762040e-01, 3.72884338e-03,-6.86277550e-04, 1.76967354e-03,
  -5.08315506e-04,-2.46691380e-04, 4.06810689e-03,-3.66181789e-03,
   4.00881886e-03, 4.46291427e-04, 2.32979312e-03,-5.19729190e-04,
  -3.11348790e-03, 9.27283576e-04,-5.85882192e-03,-2.15891287e-04,
   1.99832090e-03,-1.50190115e-02,-9.82907967e-03, 3.26312845e-02,
  -4.37994538e-03,-9.65754239e-03,-5.57457484e-03, 1.66201426e-03,
  -2.15759112e-03, 1.89241268e-03, 5.32190523e-04,-9.49207348e-04,
   1.92211945e-03, 5.03245973e-03,-3.30745840e-03, 1.65020751e-03,
   3.07501235e-03],
 [ 2.73823250e-03, 3.14971807e-03, 2.98266116e-03,-3.30337594e-03,
  -2.38346346e-03, 3.34576427e-03,-3.76371994e-03, 1.96373539e-01,
   5.04162728e-01, 1.99363985e-01, 3.35217894e-04, 2.41108585e-03,
  -7.96529912e-04, 1.21488124e-03,-1.49274899e-03,-8.68916774e-04,
  -3.65095724e-04, 3.23881065e-03,-5.73337714e-03,-2.68556212e-03,
   3.75100521e-03, 2.19329468e-03,-5.37478455e-03, 5.23908831e-03,
  -3.19895036e-03, 6.61291985e-03,-1.03165902e-02,-6.28470820e-03,
   4.52107533e-02,-2.71811699e-03,-1.54195468e-02,-1.15712021e-04,
  -1.16183677e-03, 4.65898823e-03,-2.02318779e-03,-1.17058299e-04,
   2.38961792e-03, 3.43690858e-03,-4.40777685e-03, 5.18837306e-03,
   3.86432729e-03],
 [-3.59254465e-03, 4.14954948e-03,-1.27096039e-03,-2.12317497e-03,
   1.84800981e-03, 7.33094421e-04,-3.45733884e-03, 1.64593048e-03,
   1.97848282e-01, 4.99150878e-01, 2.06717901e-01, 1.19325058e-03,
  -6.25048215e-04,-2.01098539e-03, 3.75172494e-03,-4.37319476e-03,
  -2.83285319e-03, 8.09704850e-04, 2.34149055e-03,-8.88193299e-04,
   4.83982713e-04,-1.41177196e-03,-4.28788552e-03, 1.01271881e-02,
  -5.20862687e-03, 5.53661173e-03, 1.90863148e-03,-1.14542940e-02,
  -1.90805820e-03, 3.41993211e-02,-6.14791947e-03,-1.41396540e-02,
   1.01361474e-02, 2.97559120e-03,-1.48147559e-04,-1.31153614e-03,
   6.82459862e-03, 8.87715588e-04, 7.12127865e-04,-7.42891150e-04,
   6.55510608e-03],
 [-1.70069010e-03, 1.34366940e-04, 3.09958915e-04,-1.16271820e-03,
  -2.50855105e-03, 4.94642187e-03,-5.09698620e-03, 3.80685070e-03,
   1.83185336e-03, 1.98030184e-01, 5.00899003e-01, 1.96990652e-01,
   3.57950144e-03,-7.59972923e-04, 6.68579510e-04,-3.24779275e-04,
  -1.97437702e-03,-2.11856178e-03, 3.51284235e-03,-2.91611778e-03,
  -5.25629304e-04,-3.42108016e-03,-5.84648535e-03, 1.25649741e-03,
   3.68101154e-03,-1.24125673e-03, 5.12315084e-03, 6.22214143e-03,
  -1.73825572e-02,-1.06420741e-02, 3.96265718e-02,-9.48739120e-03,
  -8.87186365e-03, 9.97373248e-03,-2.36900927e-03,-2.81157834e-03,
  -6.23485720e-03,-3.53699697e-03, 1.41559211e-03, 1.26847021e-03,
  -2.25656294e-03],
 [-2.93753523e-04, 1.73504089e-03,-3.50053568e-03,-1.35249188e-03,
  -3.83356107e-04,-5.74327921e-04, 4.25188509e-03,-3.94458574e-03,
   3.03528753e-03,-1.73054621e-04, 1.97937493e-01, 5.03267790e-01,
   2.00601548e-01, 7.75407007e-04,-1.49408419e-04,-1.90680147e-03,
  -1.83126648e-03, 3.36021823e-03, 6.78213977e-04,-2.17213569e-03,
   2.72876245e-03,-4.91073646e-03, 2.78650874e-03,-5.26349654e-03,
   6.04628542e-03, 4.97101563e-03,-5.93144992e-03,-2.61854039e-03,
  -9.68550421e-06,-1.96917832e-02,-1.25751324e-03, 3.88426861e-02,
  -2.45197238e-03,-2.07199546e-02, 9.48621165e-03,-9.36380321e-03,
   1.24396681e-03,-3.90680678e-03,-2.00816248e-03, 4.34181239e-03,
   5.48916012e-04],
 [-4.55443450e-04,-1.20039746e-03,-8.71745017e-04,-6.79684214e-04,
  -2.55395131e-03, 6.72030426e-04, 5.99439930e-04,-1.52202001e-03,
  -2.27117802e-03, 7.55406333e-04, 1.95055842e-03, 1.98078360e-01,
   5.03470372e-01, 1.99072308e-01,-6.28377311e-05, 1.25893186e-04,
  -1.08600246e-03, 2.73966532e-03,-2.07645431e-03, 2.00608183e-03,
   1.46352816e-03,-2.52272174e-03, 1.13969769e-03, 2.40645845e-03,
  -2.44473572e-03, 1.15017545e-03, 4.92982629e-05,-7.99385217e-03,
  -3.49785005e-03, 1.83855362e-03,-1.93781150e-02,-1.22524615e-04,
   3.08128101e-02,-3.89730665e-03,-1.03418045e-02, 1.61454092e-04,
   1.52447611e-03,-6.99347161e-03, 2.11435366e-03, 2.88748809e-03,
   2.12932484e-03],
 [-1.24563935e-03,-4.12551618e-03, 4.39552659e-03, 4.97623724e-04,
  -3.23024879e-03, 5.98797273e-04, 3.85506166e-04, 3.43289890e-03,
  -9.09774756e-03, 8.10791793e-03,-2.21339927e-03, 2.79493495e-03,
   1.99168004e-01, 4.97139359e-01, 1.97889982e-01, 5.78463810e-03,
  -4.37084093e-03, 6.70359009e-03,-5.21736580e-03, 3.94875134e-03,
  -4.26222798e-03,-4.11799772e-04,-4.51494792e-03, 7.78055024e-04,
  -1.89994829e-05,-6.04827127e-03,-2.17390299e-03,-1.84972113e-03,
  -3.25731018e-03, 6.69443103e-03, 1.75168562e-03,-1.75711278e-02,
   5.11761152e-04, 3.70709956e-02, 1.93170538e-04,-1.44081522e-02,
   5.98568867e-04,-6.29248589e-03,-1.28358895e-03, 9.39549302e-04,
   6.91370886e-03],
 [ 1.09859977e-03,-3.50209428e-03, 2.09345890e-03, 2.34324105e-06,
   1.48348772e-04, 2.89037586e-03,-1.17057911e-03,-6.59139062e-04,
   1.19439070e-03,-2.28610836e-03,-5.64039702e-05, 3.13577184e-03,
  -8.28969079e-04, 1.98515119e-01, 4.98909640e-01, 1.99679579e-01,
  -1.00834105e-03, 3.04962930e-03, 7.02528291e-04,-7.09935556e-03,
   4.88237016e-04, 3.03548261e-03,-1.66120851e-03,-5.13225226e-04,
   2.05651999e-03,-3.54363609e-03,-4.70505054e-04,-2.82953061e-03,
  -7.52806831e-03,-8.85133147e-04, 4.25934531e-03,-3.26285533e-03,
  -1.36554080e-02,-6.65232583e-03, 3.87116201e-02,-1.03087524e-03,
  -1.54666268e-02,-4.41697311e-03,-3.38202159e-03, 5.19767490e-03,
   1.10566908e-03],
 [ 5.22896332e-03, 1.92833276e-03, 6.61366314e-03,-1.53465102e-02,
   1.38528980e-02,-7.49610008e-04,-2.83364466e-03, 1.50675189e-04,
  -2.63960866e-03, 2.64483686e-03,-6.13039519e-03, 5.64509176e-03,
   7.54348189e-05, 2.41810200e-03, 2.01181294e-01, 5.00361770e-01,
   1.95624228e-01, 2.67160393e-03,-4.89830511e-03, 9.93907499e-04,
   3.64949483e-03,-3.46415391e-03,-4.60685370e-05,-9.30823708e-04,
  -8.13553971e-04,-3.69968289e-03,-2.30915121e-03,-3.40643120e-03,
  -1.78186763e-03,-4.58047312e-03, 8.55853042e-04,-4.72698472e-03,
  -1.44851074e-03,-1.99291359e-02,-7.08076651e-03, 3.82435587e-02,
   9.90923878e-04,-1.58731472e-02, 7.39303468e-03, 4.74469362e-03,
  -2.52762311e-03],
 [ 8.49755907e-04, 3.38974953e-03, 2.42687891e-03,-4.71580384e-04,
  -4.59886685e-04, 1.07342703e-03, 3.42124241e-03,-4.11155616e-03,
   6.46693683e-04,-2.26880046e-03, 2.82963729e-05,-3.95075232e-03,
   1.91906569e-03, 4.22623775e-03,-1.02104107e-03, 2.00626917e-01,
   5.01934937e-01, 1.99858354e-01,-2.11001202e-03, 7.37599756e-05,
   1.02079649e-03, 4.24876237e-03,-4.83060127e-03, 3.08800958e-03,
  -1.52243166e-03,-6.45918419e-04,-1.15917003e-04,-1.84442768e-03,
   3.76699877e-03,-1.64941691e-03, 1.27136201e-03,-1.01784409e-02,
   1.60619597e-03, 4.10471150e-03,-1.95990161e-02,-4.78309963e-04,
   3.74015946e-02,-6.10542907e-03,-4.69707030e-03, 5.79704556e-04,
  -3.00768007e-03],
 [-1.16185566e-03, 5.69415288e-03,-6.29176382e-03, 7.23277498e-03,
   3.78442784e-03,-7.52473373e-03, 5.74501772e-03,-2.06607494e-04,
  -3.31182008e-03, 3.63888222e-03,-1.28932232e-03,-5.85556472e-03,
   3.26250086e-03, 3.67258247e-03,-2.09611905e-03,-5.04421939e-04,
   2.04654081e-01, 4.98197974e-01, 2.02555040e-01,-6.42396502e-03,
  -5.25402027e-04, 4.93773030e-03,-3.14942255e-03,-2.45581188e-03,
   1.26723816e-03,-6.67887404e-05,-3.66510781e-03, 1.38609934e-04,
   7.95408816e-04,-4.74938033e-03, 2.00026871e-04,-4.04315812e-03,
   3.52361530e-03,-4.15098111e-03, 7.83632798e-03,-1.35248668e-02,
  -2.09194279e-03, 3.45960580e-02,-7.43704933e-03,-1.31316897e-02,
   1.89619650e-03],
 [-4.12123274e-03, 4.07054460e-03,-4.33167759e-03, 1.09558329e-04,
  -8.56502744e-04, 1.07426994e-03, 4.16686070e-03,-1.42153240e-03,
   1.64780325e-03,-3.49747397e-03, 6.55014025e-03,-3.14009442e-03,
  -4.12945848e-03, 4.97724303e-03,-1.00157396e-03,-2.69624251e-03,
   6.65639598e-03, 1.91280214e-01, 5.02585494e-01, 1.98287926e-01,
   3.35736063e-03,-1.64584576e-03,-4.10252568e-04, 3.40854178e-03,
  -4.61919342e-03, 4.37413188e-04,-3.08411429e-03, 3.28958054e-03,
   2.86660712e-03, 2.07808064e-03, 3.36874558e-03,-2.96842743e-03,
   4.76581157e-03,-4.26024185e-03, 6.06133609e-03, 3.54357245e-03,
  -1.33474767e-02,-4.98373081e-03, 3.44299850e-02,-2.46437261e-03,
  -1.18701396e-02],
 [ 6.21217900e-03, 8.07667824e-03,-2.67181303e-03,-4.84434735e-03,
   1.80381374e-03,-3.85696707e-04, 3.53054670e-04, 1.81107148e-03,
  -1.93480595e-03, 3.78719521e-04,-1.62887945e-03, 1.87722451e-03,
  -9.35212933e-05, 2.91206478e-03,-3.87147158e-03, 7.46978324e-04,
   4.95500118e-03,-2.80081458e-03, 1.94740937e-01, 5.00362507e-01,
   2.02338281e-01,-3.82264913e-04, 2.98127482e-03, 3.12194756e-03,
   3.84333302e-04, 2.75925837e-03,-1.97359028e-03, 5.07519707e-03,
   4.97850892e-03, 8.53505588e-04,-8.66276306e-04,-5.34638527e-03,
   4.53851204e-03,-9.81227055e-03, 9.75214675e-04, 3.64196358e-03,
   5.83533305e-03,-1.18785717e-02, 4.28036255e-04, 2.65519180e-02,
  -1.98047126e-03],
 [-1.29353359e-04, 8.23331170e-03,-2.49688169e-03,-1.27595055e-03,
  -1.83568914e-03, 3.33858937e-03, 1.53440245e-03,-1.25278432e-03,
  -1.72370990e-03, 1.71782583e-03,-5.00126696e-03, 2.12987107e-03,
  -1.52716183e-03,-6.91346487e-04, 4.95178689e-03,-5.24674169e-04,
   6.06120914e-03,-5.30566574e-03,-1.10214206e-03, 1.97337953e-01,
   5.00690230e-01, 2.13555812e-03,-1.29589360e-03, 7.12487610e-03,
  -5.78377167e-03, 3.06637415e-03, 1.59696098e-03, 4.78498617e-03,
   3.64381439e-03, 2.20573764e-03,-2.90527861e-03,-3.98654961e-04,
   2.18627946e-03,-9.72124416e-03,-3.98261695e-03, 1.42499272e-03,
   1.58226851e-03, 9.08538293e-03,-1.35794935e-02,-1.53021791e-02,
   5.65677374e-02]])
    

        # Initialize the start observation
        self._old_ob = np.array(10 * np.ones(self.dimension))
        self._current_step = 0
        self._done = False

    def action_spec(self):
        return self.action_space

    def observation_spec(self):
        return self.observation_space

    def _reset(self):
        self._current_step = 0
        self._old_ob = np.array(10 * np.ones(self.dimension))
        self._done = False

        return self._old_ob.copy()

    def _step(self, action):
        action = np.clip(action, -1., 1.)

        # decide whether to reset the model
        if self._done:
            self._reset()
        feature = np.hstack(([1],self._old_ob,action))
        # get the observation
        ob = np.dot(self.transition, feature) + np.random.multivariate_normal(mean=self.mean, cov=self.identity)

        # get the reward
        reward = self.reward(
            {'end_state': ob, 'start_state': self._old_ob, 'action': action}
        )

        # get the end signal
        self._current_step += 1

        info = {}
        info['reward'] = reward
        info['current_step'] = self._current_step

        if self._current_step >= self._env_info['max_length']:
            done = True
            self._done = True
        else:
            done = False
            self._done = False

        self._old_ob = ob.copy()
        return ob, reward, done, info

    def reward(self, data_dict):
        # TODO: Change the reward like let the reward be small
        return -0.05 * (np.linalg.norm(data_dict['start_state']) ** 2)


# env_name = 'IVVI'
# environment = env(env_name, 123, {'reset_type': 'gym'})
# tf_env = tf_py_environment.TFPyEnvironment(environment)
# print(isinstance(tf_env, tf_environment.TFEnvironment))
# print("TimeStep Specs:", tf_env.time_step_spec())
# print("Action Specs:", tf_env.action_spec())




