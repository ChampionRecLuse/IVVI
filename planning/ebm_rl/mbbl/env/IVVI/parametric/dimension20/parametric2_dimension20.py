# coding=utf-8
# Copyright 2021 The Google Research Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""Training and evaluation in the online mode."""
from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import collections
import os
import time
from typing import Any

from absl import logging

import gin
import numpy as np
import tensorflow.compat.v1 as tf
from brac import dataset
from brac import policies
from brac import train_eval_utils
from brac import utils
from mbbl.env import env_register
import random
from tf_agents.environments import tf_py_environment
from tf_agents.environments import py_environment
from tf_agents.environments import tf_environment
from tf_agents.specs import array_spec
from tf_agents.trajectories import time_step as ts
from tf_agents.environments import utils
from gym.spaces import box


class env(py_environment.PyEnvironment):

    def get_info(self) -> Any:
        pass

    def get_state(self) -> Any:
        pass

    def set_state(self, state: Any) -> None:
        pass

    def __init__(self, env_name, rand_seed, misc_info):
        self._env_name = env_name
        self._seed = rand_seed
        self._npr = np.random.RandomState(self._seed)
        self._misc_info = misc_info
        self._env_info = env_register.get_env_info(self._env_name)
        self.dimension = 20
        # self._action_spec = array_spec.BoundedArraySpec(
        #     shape=(), dtype=np.int32, minimum=-1, maximum=1, name='action')
        # self._observation_spec = array_spec.BoundedArraySpec(
        #     shape=(), dtype=np.int32, minimum=-100, maximum=100, name='observation')
        self.action_space = box.Box(low=-1.0, high=1.0, shape=(self.dimension,), dtype=np.float32)
        self.observation_space = box.Box(low=-np.inf, high=np.inf, shape=(self.dimension,), dtype=np.float32)
        self.P = 0.5 * np.eye(self.dimension) + np.diag(0.2 * np.ones(self.dimension-1),k=1) + np.diag(0.2 * np.ones(self.dimension-1),k=-1)
        self.Q = 0.5 * np.eye(self.dimension) + np.diag(0.1 * np.ones(self.dimension-1),k=1) + np.diag(0.1 * np.ones(self.dimension-1),k=-1)
        self.mean = np.zeros(self.dimension)
        self.identity = np.eye(self.dimension)
#         self.transition = np.array([[-1.26381029e-03, 4.97619457e-01, 2.05726344e-01, 5.17601552e-03,
#   1.27125134e-02, 1.34271147e-02,-7.10463678e-03,-6.64762883e-03,
#   9.46115781e-03, 1.74154345e-02, 9.42523666e-03, 8.75226681e-03,
#   8.42286987e-03, 1.48999310e-02, 1.07190105e-02,-3.92415688e-03,
#   5.70393133e-03, 2.80176822e-03,-6.12483498e-03,-8.45248858e-03,
#   6.40546220e-03,-3.39331728e-01,-6.19124550e-02, 6.88930824e-04,
#   6.16508530e-04, 1.90205840e-02, 2.35110875e-02, 9.20105183e-03,
#   -1.05781299e-03, 6.10793912e-03, 2.20017540e-02, 1.03587452e-02,
#   4.12586484e-03, 1.18871892e-02, 7.53995487e-03, 2.20202816e-02,
#   1.49578630e-02, 6.97063252e-03, 4.08273946e-03, 2.18553657e-02,
#   4.93722819e-03],
#  [ 5.05203514e-03, 2.09502906e-01, 5.03057134e-01, 1.96634600e-01,
#   -1.16659108e-03, 4.47384923e-03,-8.36160078e-03,-1.15387707e-02,
#   -5.56727279e-03, 2.25217765e-03, 5.42334515e-03, 6.29788108e-03,
#   2.36096123e-03,-1.39883747e-02, 4.35910999e-03,-1.29153435e-02,
#   -1.31382958e-02, 3.30252234e-03,-5.09510892e-03,-1.36693741e-03,
#   4.29777174e-03,-4.44911019e-02,-3.28735480e-01,-5.11569047e-02,
#   7.95912536e-03, 2.77372937e-02, 1.82257979e-02, 1.83045894e-03,
#   1.94549995e-02, 6.79938350e-03, 2.00291636e-02, 8.77542076e-03,
#   1.64675347e-02,-1.01206565e-02,-6.41211601e-03, 1.26762891e-02,
#   1.13650519e-02,-2.44968184e-03, 1.30851413e-02, 2.00410768e-02,
#   2.06961172e-02],
#  [ 3.35843606e-03, 1.87337073e-02, 2.01063013e-01, 4.87845508e-01,
#   1.93770152e-01,-4.97470796e-03,-5.84300839e-03,-6.56192591e-03,
#   4.72573206e-03, 4.52863692e-03, 3.57752670e-03, 1.50306668e-02,
#   3.73235146e-03, 3.72705195e-03,-7.66368937e-03,-6.11925590e-03,
#   -1.33030195e-03, 1.72131164e-02,-3.71319100e-03,-7.09570783e-03,
#   3.69293391e-03, 2.42559454e-02,-6.25021561e-02,-3.39586499e-01,
#   -5.96914403e-02, 1.91929941e-02,-3.44532026e-03, 1.19294423e-02,
#   2.03832227e-02, 1.42140089e-02, 3.86785066e-03,-1.45560432e-03,
#   9.65479692e-03, 7.26218225e-03,-5.44244391e-03, 1.86219249e-02,
#   4.75626993e-03,-2.06549853e-03, 1.36910977e-02, 2.43606108e-02,
#   1.07831861e-02],
#  [-7.88790872e-05, 8.57269964e-03,-5.07346299e-03, 1.80533330e-01,
#   5.03016680e-01, 1.98809597e-01,-3.15993979e-03, 1.64200477e-03,
#   3.27065615e-03,-1.43720153e-03,-2.66959917e-03,-2.48014888e-03,
#   -7.64092539e-03,-9.45396346e-03,-9.76158903e-03,-6.98355026e-03,
#   -5.82610138e-03, 1.17193546e-02, 9.33087792e-03, 5.12917240e-03,
#   2.32027122e-02, 1.50302049e-02,-1.20748708e-03,-4.50822725e-02,
#   -3.30203492e-01,-5.87305144e-02,-5.90408199e-03, 2.80955753e-02,
#   1.10059349e-02, 1.19083507e-02, 1.13651684e-02, 1.12031460e-02,
#   1.55266054e-03, 1.55043231e-02, 7.76337564e-03, 1.67515933e-02,
#   7.31773640e-03, 1.19835385e-02, 1.13460124e-02, 2.04639957e-02,
#   5.45972037e-03],
#  [ 1.61231025e-03,-3.06343504e-03, 2.00436278e-03, 2.29123936e-03,
#   2.08024376e-01, 5.10186769e-01, 1.97295353e-01, 5.12087819e-03,
#   2.00794937e-03,-1.50660539e-03, 4.31592612e-03,-7.79908186e-05,
#   -1.04271042e-02,-3.16505960e-03,-2.81787993e-03,-1.13230079e-02,
#   4.51298342e-03,-8.36230582e-03, 7.46065419e-03, 5.47908289e-03,
#   5.93093581e-04, 1.40305202e-02, 1.02900291e-02, 2.03211631e-02,
#   -4.57327014e-02,-3.39216119e-01,-6.09486646e-02, 8.83358629e-03,
#   3.82484336e-03, 1.96564816e-02, 1.66997165e-02,-1.07976300e-02,
#   1.55760375e-02, 1.85026058e-02, 2.06871579e-02, 7.59060387e-03,
#   7.67452616e-03, 2.42755574e-02, 1.77595935e-02, 1.70547077e-02,
#   6.67913852e-03],
#  [-1.75853420e-03, 1.37678434e-02,-2.07321351e-03, 1.01104671e-02,
#   1.15328028e-02, 2.09706327e-01, 5.07436726e-01, 2.06913919e-01,
#   1.71079497e-02, 7.42386418e-03,-1.77475491e-03, 5.63123981e-03,
#   -1.11285680e-03,-1.01223419e-02, 3.36504422e-03,-4.75010478e-03,
#   -1.87805505e-03,-1.24899145e-02, 1.01864769e-03,-4.87912424e-03,
#   -1.20955664e-02, 2.46781295e-03, 2.01177266e-02, 2.28607184e-02,
#   1.02379895e-02,-4.44138409e-02,-3.20499448e-01,-5.14033399e-02,
#   9.58726933e-03, 3.31821865e-03, 5.17047536e-04, 1.00955111e-02,
#   2.14662765e-02, 1.20000752e-02, 1.02534103e-02, 7.87354502e-03,
#   1.20486447e-02, 1.41544193e-02, 5.98615793e-03, 1.28654518e-02,
#   2.06232335e-02],
#  [-9.71835133e-03, 1.40385226e-02,-7.01835606e-03, 1.10733989e-02,
#   -3.85703139e-03, 9.50247534e-03, 2.15384677e-01, 5.02282020e-01,
#   2.07633090e-01, 1.95271548e-02,-7.66640733e-03,-3.19617650e-04,
#   4.17609190e-03,-4.71126327e-03,-4.32488414e-03,-1.82374628e-03,
#   -4.15229767e-03,-2.58529733e-03, 1.03621318e-02,-1.13784596e-03,
#   -6.09902780e-03, 8.78575948e-04, 5.29341371e-03, 2.42916559e-02,
#   1.15806911e-03, 1.53803824e-02,-5.64940727e-02,-3.26440167e-01,
#   -5.02897804e-02, 4.33427222e-03, 3.64040809e-03, 6.93925777e-03,
#   9.84499857e-03, 1.11967567e-02, 8.55770546e-03, 7.51443953e-03,
#   -5.53370874e-03, 2.04031415e-02, 6.53808654e-03, 3.57035850e-03,
#   1.54748661e-02],
#  [-3.01792524e-03,-4.89472710e-03, 1.83307296e-02, 7.74402248e-03,
#   5.50383770e-03, 1.69076321e-03, 1.02817913e-03, 1.95185460e-01,
#   5.03279858e-01, 2.14565137e-01, 2.17462617e-02, 4.19397360e-03,
#   7.49191173e-03, 2.46016118e-03, 2.07725521e-03,-6.14320684e-03,
#   7.65131223e-03,-5.43708303e-04, 2.22954646e-03, 8.05457570e-05,
#   -4.47543460e-04, 1.15049691e-02,-1.25778238e-02, 2.15912373e-02,
#   2.86440996e-02, 1.92340382e-02, 1.08563946e-02,-5.73870116e-02,
#   -3.28723281e-01,-6.13504121e-02, 9.68954375e-03, 5.95028285e-03,
#   -6.65980954e-03, 6.25700917e-03, 7.10506284e-03, 1.21474858e-02,
#   1.27209197e-02, 7.19039166e-03, 4.40028149e-03, 1.41341921e-02,
#   4.99688468e-03],
#  [-5.79982152e-03, 4.41199965e-03, 6.74849681e-03,-8.09623556e-04,
#   1.19443083e-02,-4.06130741e-03,-1.04108992e-02, 2.34555154e-03,
#   1.97269159e-01, 5.05204004e-01, 2.17341966e-01, 7.38132325e-03,
#   1.49287059e-03,-3.88529700e-03, 1.54569531e-03, 5.05178449e-03,
#   -8.27857965e-03,-1.65398978e-02,-1.05001012e-02, 5.95230797e-03,
#   -1.05414768e-02, 2.16084590e-02,-1.17846963e-02, 1.49462196e-02,
#   1.15000173e-02,-5.29042781e-03, 9.46433063e-04, 7.50471641e-05,
#   -4.39200385e-02,-3.36210817e-01,-4.50044699e-02, 1.36343173e-02,
#   1.97464200e-03, 8.00808663e-03, 8.33553750e-03, 2.12072795e-02,
#   1.76776589e-02, 1.66115602e-02, 1.63276523e-02, 2.77656628e-02,
#   5.25736903e-03],
#  [ 6.47380293e-03,-6.39535649e-03,-5.47491858e-03,-2.61582331e-03,
#   -1.51563948e-02,-2.48089305e-03,-7.72185194e-03,-1.26764057e-02,
#   -1.49065289e-02, 1.91965529e-01, 4.95665587e-01, 1.92069655e-01,
#   -6.58102506e-03,-1.38502504e-02,-2.54322039e-03,-9.64021929e-04,
#   -4.35695801e-03,-4.35357049e-03,-4.77866112e-03,-5.43194818e-03,
#   -2.39623048e-03, 1.66430252e-02, 2.20181633e-05, 7.74041595e-03,
#   3.83103073e-03,-1.93953926e-03, 7.33931289e-03, 1.99037788e-02,
#   -2.80676002e-04,-4.91251884e-02,-3.23710954e-01,-4.70065027e-02,
#   2.19147677e-03, 9.23012746e-03, 4.42847640e-03, 6.45439740e-03,
#   1.69764200e-02, 1.81106360e-02, 5.31862509e-03, 1.62304005e-02,
#   -4.40802740e-03],
#  [ 1.45836295e-02, 6.57103485e-03, 3.75605992e-03,-2.37236359e-02,
#   8.48675210e-04,-2.52517681e-03,-3.96010270e-04,-3.77808451e-03,
#   -8.71534593e-03,-9.45944270e-03, 1.87462641e-01, 4.93479608e-01,
#   1.98802535e-01, 1.22678582e-03,-6.83417247e-03, 3.34483376e-03,
#   -6.25063712e-03, 1.62532801e-03, 1.03217080e-03,-1.23450544e-02,
#   -9.32025950e-04, 1.20583838e-02, 9.43714679e-03, 2.36684202e-02,
#   1.66058569e-02, 1.00146280e-02,-2.96512947e-03, 2.44779063e-02,
#   5.88351605e-03, 3.78750533e-03,-4.39061740e-02,-3.30727989e-01,
#   -4.91532692e-02, 1.68330366e-02, 4.86353355e-03, 4.00529990e-03,
#   1.16336264e-02, 1.32899384e-02, 8.29048976e-03, 2.75194885e-02,
#   4.36448636e-03],
#  [ 4.44856433e-03,-3.94688847e-03, 1.05094840e-02,-8.76123123e-03,
#   -3.58583446e-06, 2.26999976e-03, 8.31932110e-06,-1.41364076e-04,
#   -2.39594321e-03,-1.56650064e-02,-1.33190564e-02, 1.92117650e-01,
#   5.12474426e-01, 1.86431191e-01, 6.95456787e-03,-1.02550013e-02,
#   -1.52563889e-02,-1.94134140e-03,-8.17908320e-03, 3.64349892e-03,
#   -4.84649408e-03, 1.97123847e-02, 1.46224751e-02, 2.25815856e-02,
#   1.24763456e-03, 1.90988806e-03,-1.24581541e-02, 3.78379370e-03,
#   8.97133479e-03,-4.59398818e-03, 1.48087662e-02,-5.27508342e-02,
#   -3.22037704e-01,-3.55300832e-02, 1.92990594e-04, 7.58705041e-03,
#   1.81993173e-02, 8.71102165e-03, 8.16576857e-03, 2.12325229e-02,
#   1.41473947e-02],
#  [ 7.86921578e-04, 8.11380037e-04,-6.17092033e-03, 2.19011387e-02,
#   -8.77678208e-04,-5.21672660e-03,-3.45471082e-03, 1.84801457e-02,
#   -2.21041992e-03, 2.30986591e-03,-2.34120991e-02, 5.51145908e-03,
#   1.95458584e-01, 4.95915058e-01, 2.01177912e-01,-1.20763183e-02,
#   2.13793514e-03, 3.76230012e-04,-7.06401487e-03, 1.01779267e-02,
#   -4.13795252e-03, 1.38569658e-02, 9.06720185e-03, 2.32763036e-02,
#   -2.08897239e-03, 5.28089396e-03, 3.91893649e-03,-9.39273112e-03,
#   3.45061097e-06, 1.96263238e-02, 1.25726801e-02, 9.89567290e-03,
#   -4.57187899e-02,-3.42168614e-01,-4.32043517e-02, 8.82651866e-03,
#   6.88914327e-03, 8.29342029e-03, 1.07567133e-02, 2.71448150e-02,
#   7.25381206e-03],
#  [ 6.87923416e-03,-1.92642663e-03, 2.51560784e-04, 4.95555729e-03,
#   4.70135702e-03, 6.88888406e-04, 3.17208342e-03, 3.98266122e-03,
#   2.50351154e-03, 1.31927438e-02,-2.09699172e-02,-6.86017910e-03,
#   1.00006614e-03, 1.94864404e-01, 5.10295442e-01, 1.88867178e-01,
#   -1.00924475e-03, 6.08026117e-03, 1.52193452e-02, 2.74872007e-02,
#   2.54793030e-03, 2.01576326e-02, 2.01093102e-02, 2.22911036e-02,
#   1.30090239e-02, 2.15475636e-03, 1.49989504e-02, 9.82173976e-03,
#   2.74250602e-04, 6.03762805e-03, 9.41780063e-05, 1.48718244e-02,
#   4.06015067e-03,-4.87962880e-02,-3.30110300e-01,-4.04972431e-02,
#   1.71712780e-04, 1.32300761e-02, 1.39244989e-02, 1.38236537e-02,
#   5.82332532e-03],
#  [-1.98992962e-03, 3.00649476e-03, 3.10769410e-03, 5.87069610e-03,
#   1.06752539e-02, 2.27535430e-03, 9.23382761e-03, 4.11648995e-03,
#   -1.70891814e-03, 1.73234147e-02, 1.55866088e-03, 1.62505373e-03,
#   2.71619754e-03,-4.74101213e-03, 1.95137952e-01, 4.97441949e-01,
#   2.02333399e-01,-1.14742861e-03, 1.52197347e-02, 4.66119435e-03,
#   -1.30543308e-02, 2.78651050e-02, 1.89012511e-02, 1.95629218e-02,
#   2.40110945e-02, 6.60115059e-03, 9.02563856e-03, 2.98155926e-02,
#   3.56670850e-03, 1.93734337e-02, 1.67119307e-02, 5.86321358e-03,
#   1.14360946e-02, 1.27927524e-03,-4.75181861e-02,-3.33666348e-01,
#   -5.21649312e-02, 1.29226620e-02, 1.88992663e-02, 5.31662352e-03,
#   1.87597798e-02],
#  [ 8.13624175e-04,-5.25542345e-03, 8.45386323e-03,-1.10649247e-02,
#   -2.17223418e-03,-7.57459987e-03,-1.62166750e-02,-3.81593547e-03,
#   7.63923917e-03, 6.83950568e-03,-1.51538756e-03,-1.33213500e-02,
#   -1.39210495e-02, 2.96370613e-03, 4.76629952e-05, 2.07918119e-01,
#   5.05289468e-01, 1.91618341e-01, 7.54167235e-03,-1.74067487e-02,
#   -9.95710092e-03, 2.55497437e-02, 1.86735003e-02, 1.10609185e-02,
#   2.12248243e-02, 1.38162506e-02, 1.05109149e-02, 2.21835362e-02,
#   3.54726455e-03, 1.71429877e-02, 2.79780287e-02, 8.15710277e-03,
#   3.94641505e-03, 7.75897858e-03, 2.51310012e-03,-5.72529951e-02,
#   -3.34719324e-01,-4.18210620e-02, 2.84871436e-02, 1.73017896e-02,
#   7.60150727e-03],
#  [ 1.23771482e-03, 5.01358777e-03,-4.09947229e-04,-3.94126960e-03,
#   -3.08125662e-03,-1.26904340e-02,-7.81506077e-03,-6.41461842e-03,
#   1.40648351e-02, 1.54411842e-02, 2.34366743e-03,-1.73545397e-02,
#   5.35694442e-03, 5.76447787e-04, 5.77731828e-03, 4.18473740e-03,
#   1.92103986e-01, 4.94797307e-01, 2.06263087e-01,-4.20671716e-03,
#   1.86879312e-02, 1.82228286e-02, 1.14091653e-02, 2.16935787e-02,
#   9.94432610e-03, 1.85704023e-02, 1.47909222e-02, 1.63374998e-02,
#   -3.80108753e-03,-2.40467168e-03, 1.80615644e-02, 2.36369883e-02,
#   8.62330496e-03, 1.00815471e-02, 2.52503795e-03, 5.00957175e-03,
#   -6.70000297e-02,-3.43870043e-01,-4.87564242e-02, 9.30144930e-03,
#   -3.00197819e-03],
#  [ 6.60441426e-03, 4.91217215e-03,-1.01855025e-02, 6.22933720e-03,
#   -7.23354931e-04, 5.02860765e-03,-1.57479952e-02,-5.68347895e-03,
#   -7.04599291e-03,-1.10681878e-03, 7.20334312e-03,-6.40613514e-03,
#   6.48789230e-03, 2.35722145e-03,-1.33395128e-02, 4.26290108e-03,
#   6.17979667e-04, 1.99761457e-01, 4.88830476e-01, 1.98809444e-01,
#   3.54561208e-03, 2.46381790e-02, 5.16167098e-03, 1.62326578e-02,
#   1.09815965e-02, 1.56915425e-02, 1.04362196e-02, 1.35593411e-02,
#   3.64023905e-03, 1.84821649e-02, 1.58276357e-02, 9.60970050e-03,
#   8.72911629e-03, 1.30993159e-02, 1.25336806e-02, 1.66029966e-02,
#   5.68099217e-03,-6.60596514e-02,-3.29337626e-01,-5.64314411e-02,
#   9.40109348e-03],
#  [-1.16873428e-02,-9.98072059e-03,-1.44276827e-03, 1.77107540e-03,
#   -1.05056296e-02, 1.31301285e-02,-6.72715427e-03, 2.51778122e-03,
#   -7.24778231e-03,-6.69008376e-03, 1.05084383e-02,-9.16573330e-03,
#   -1.03499387e-02,-5.24961630e-03, 4.35719350e-03,-5.45814702e-03,
#   -7.44997503e-03, 2.43769308e-03, 2.03080602e-01, 5.00478996e-01,
#   2.06870874e-01, 2.69442494e-02, 2.29082853e-02, 2.53730904e-02,
#   -4.55756993e-03, 9.91499857e-05, 1.55411277e-02, 1.26847527e-03,
#   7.24170319e-03,-2.68847785e-03, 1.26086850e-02, 2.46156122e-02,
#   1.38671386e-02, 1.13883722e-02, 4.87212706e-03, 1.44750122e-02,
#   5.03001013e-03, 1.57767764e-02,-4.75391344e-02,-3.35426821e-01,
#   -3.64261223e-02],
#  [-1.06215379e-03,-8.15297249e-03,-3.56458943e-03,-5.83150741e-03,
#   -2.58972344e-02,-1.09465719e-04,-2.23810744e-03, 1.34042953e-03,
#   5.17665475e-04,-1.80710560e-02,-5.64579402e-03,-3.33685922e-03,
#   -1.25509460e-02, 2.60481683e-03,-5.72081007e-03,-1.32849429e-02,
#   -1.07627266e-02,-7.57693421e-03,-3.84151797e-03, 2.11036086e-01,
#   5.06106018e-01, 1.20573761e-02, 1.68421263e-02, 3.39289728e-02,
#   4.92492946e-03, 8.84517354e-03, 5.65805147e-03, 9.54691590e-03,
#   2.41705081e-02, 7.82820231e-03, 1.12932276e-02, 1.29108024e-02,
#   5.81273130e-03, 1.29907458e-02, 8.51565725e-03,-5.94932661e-03,
#   5.37381298e-03, 4.90949436e-03, 1.41351923e-02,-5.22438946e-02,
#   -3.22447235e-01]])
    
    
        self.transition = np.array([[-6.07280255e-03, 5.00432704e-01, 1.92798926e-01, 7.22428267e-03,
  -1.00354990e-02,-1.29482370e-02, 8.86434486e-03, 5.35318076e-03,
  -1.44600492e-03,-8.47423262e-04, 3.45371871e-03, 1.03736273e-02,
  -1.57169185e-02, 7.38745872e-03, 1.11875022e-02, 2.60559290e-03,
   3.08074575e-03, 5.01984636e-03,-6.56281987e-03, 3.74351018e-03,
   2.80139601e-04,-3.31643784e-01,-4.54636251e-02, 1.63696247e-02,
   1.08263922e-02, 2.37272237e-02, 1.99378089e-02, 2.09893872e-02,
   1.62306642e-02, 3.74516599e-03,-5.38548408e-03, 2.04295260e-02,
   1.04276757e-02, 2.02735505e-02, 1.26840599e-02, 7.53549379e-03,
   1.45076053e-02, 1.01365027e-02,-3.25161775e-03, 1.10246642e-02,
   1.75771886e-02],
 [-7.59972664e-03, 2.01717645e-01, 4.93239004e-01, 1.94814020e-01,
   7.94776297e-03,-8.27395153e-03, 1.18777151e-03,-4.68819565e-04,
   4.19653560e-03,-5.24770408e-03, 1.33161926e-03, 8.59375304e-03,
  -1.44299775e-02, 8.52535119e-03, 1.76518768e-02,-5.08597370e-03,
  -5.77080401e-03, 6.51596549e-03,-5.27949818e-03, 1.23060747e-02,
   1.47049090e-02,-5.93551890e-02,-3.35462812e-01,-4.12214013e-02,
   1.35025201e-02, 9.41034003e-03, 1.34149547e-02, 1.70957989e-02,
   1.89506776e-02, 2.02630535e-02, 4.72399363e-03, 2.53460916e-03,
   5.33376030e-03, 1.71275072e-02, 3.82163924e-03, 3.21063323e-03,
   1.78512296e-02, 8.31779763e-03,-6.22727994e-03, 1.45888050e-02,
   1.16936124e-02],
 [ 6.01762737e-03,-6.95014576e-03, 1.79159627e-01, 5.06291061e-01,
   1.93892616e-01, 2.50652920e-04,-2.60190683e-03,-8.64877505e-03,
  -1.86652581e-02,-7.60538355e-03, 1.78564513e-03,-1.42494263e-03,
  -4.15487875e-03, 2.19252543e-03,-6.66626193e-04,-1.99886501e-02,
  -1.34367277e-03, 9.31301405e-03,-4.82215026e-03,-1.12443609e-02,
  -3.82622938e-03, 7.70077266e-03,-5.31952508e-02,-3.39338531e-01,
  -4.22945510e-02, 5.03321745e-03, 7.35257003e-03, 1.48390969e-02,
   2.30416401e-02, 1.75619597e-02, 1.43643512e-02, 7.93128492e-03,
   1.14153364e-02, 5.19828643e-03, 1.43661801e-02, 6.37423503e-03,
   2.56218613e-02, 9.23167980e-03,-2.36896082e-03, 6.61781705e-03,
   5.30500856e-03],
 [ 7.13833283e-03, 3.50380576e-03, 3.94295120e-03, 1.94160255e-01,
   5.10188840e-01, 1.88908727e-01, 2.35942244e-03,-6.72106476e-03,
   7.88900625e-03, 1.17029704e-02, 5.80210281e-03, 1.35223059e-03,
   5.55009193e-03, 4.95059344e-03, 4.53247773e-03,-3.67003486e-03,
  -7.62508591e-03, 3.93730872e-03, 7.33964685e-03,-1.14133971e-02,
   5.07747034e-03, 1.85972505e-02, 1.08787960e-02,-4.33356778e-02,
  -3.34107792e-01,-4.57260869e-02, 8.84299483e-03, 9.35060359e-03,
   2.24403145e-02, 2.06944028e-02, 5.88861679e-03, 1.90586148e-02,
   1.74539179e-02,-1.71697034e-03, 6.77473638e-03, 2.41391856e-02,
   1.30503564e-02, 1.36518201e-02, 9.95510580e-03, 1.87694339e-02,
   1.06899361e-02],
 [ 4.67680596e-03, 1.08242524e-02,-6.03969623e-03, 8.28771892e-03,
   1.96406793e-01, 4.96584687e-01, 1.94755013e-01, 7.41693709e-03,
  -1.11180959e-02, 9.84109919e-03, 6.89301358e-03,-3.85007172e-03,
  -9.45665736e-04, 6.46046061e-03,-1.40987214e-02,-1.03811728e-03,
   4.27251379e-03, 5.64556556e-03, 5.61817710e-03,-1.03877731e-02,
   2.31172583e-03, 1.25440654e-02, 1.28569266e-02, 2.90273412e-03,
  -4.44525328e-02,-3.43363704e-01,-6.40697869e-02, 5.05947744e-03,
   8.17600008e-04, 2.27832615e-02, 1.42626178e-02, 1.25551787e-02,
   2.29045693e-02, 2.23155560e-02, 1.50495051e-02, 2.01826650e-02,
   2.14395714e-02, 6.79872418e-03,-4.03683946e-03, 2.70657972e-03,
  -1.66417721e-04],
 [-8.78792379e-03,-3.78130984e-03, 1.10705154e-03, 1.43472901e-02,
  -4.15870775e-03, 1.86840150e-01, 5.07008536e-01, 2.04142927e-01,
   7.92357238e-03,-1.82388717e-03,-7.81037221e-03, 7.15465436e-03,
   9.40404343e-03,-4.71157259e-03,-8.44488709e-03,-2.86582564e-03,
   1.73490357e-02, 5.37520694e-03,-2.00330781e-03, 1.10018764e-02,
   4.15382915e-03, 5.53893369e-03, 2.77691111e-02, 8.81543594e-03,
   1.32740219e-02,-5.02266832e-02,-3.45154812e-01,-4.17417726e-02,
   5.16891897e-03, 1.95978908e-03, 2.40968888e-02, 9.63345072e-04,
   4.80263528e-03, 2.43265562e-02, 1.28471446e-02, 1.26165444e-02,
   1.46045998e-02, 2.33557069e-03, 1.30078175e-03, 7.20537612e-03,
   9.73780950e-04],
 [-7.00600045e-03,-1.16026965e-04, 3.36317996e-03, 1.21409837e-03,
  -6.84816238e-04,-4.58149020e-03, 1.93175226e-01, 4.88319564e-01,
   2.02845877e-01, 1.86828659e-03, 2.31504759e-03,-3.16274309e-03,
   1.60201046e-03, 3.39259971e-03, 1.48668724e-03, 1.42122180e-03,
  -2.66703253e-03,-8.02276957e-03,-4.38253199e-03, 2.38099899e-03,
  -1.67921752e-03,-2.28186729e-03, 1.15346833e-02, 3.50292192e-03,
   8.80832888e-03,-8.28582117e-03,-5.30626246e-02,-3.27913909e-01,
  -6.38565292e-02, 3.55252859e-03, 1.12260082e-02, 3.42962647e-03,
  -4.74348163e-03, 1.95946642e-02,-2.64936418e-03, 4.30746906e-03,
   2.50207389e-02, 1.68728756e-02, 7.85609370e-03, 4.17317394e-03,
   1.23279070e-02],
 [-4.91793166e-03, 4.41441127e-03,-1.16077673e-02,-1.36715929e-02,
   3.46677146e-03,-1.52072681e-02,-9.82566458e-03, 1.88123764e-01,
   5.04170708e-01, 2.02013763e-01,-4.70243620e-03,-1.33209807e-02,
  -6.43790275e-03,-9.02738698e-04,-2.50760086e-03,-2.82103993e-03,
  -1.81653237e-02, 3.81870916e-03,-6.53928029e-03, 4.42658679e-03,
  -1.34081612e-03, 6.16727183e-03, 3.93058464e-03, 8.35143877e-03,
  -2.83192378e-03,-3.84638143e-03, 9.92394722e-04,-5.98980204e-02,
  -3.39812838e-01,-4.97994799e-02, 4.10291064e-03, 1.74096415e-02,
   7.95944292e-03, 4.87679863e-03, 7.19513351e-03, 5.81964805e-03,
   6.03368207e-03, 1.26986749e-02, 1.52593943e-02, 6.22939314e-03,
  -4.19875735e-03],
 [-4.47056826e-03,-1.79384511e-03,-4.98386713e-03,-9.73207014e-04,
  -2.97377456e-03,-3.72763689e-03, 1.31065809e-02, 1.30878866e-02,
   1.89526894e-01, 4.91176895e-01, 1.96957845e-01, 6.38232359e-05,
  -6.35864073e-03,-9.80844809e-03,-8.66192243e-03,-1.73168008e-03,
  -7.14753142e-03, 5.72917952e-03,-3.17300087e-03, 5.03470241e-03,
  -9.88213486e-03, 1.67143452e-02,-1.22781974e-03, 8.78583011e-03,
   7.81608280e-03, 5.98008022e-03, 7.78379162e-03, 5.61586297e-03,
  -5.79652962e-02,-3.38033748e-01,-5.70395187e-02, 6.32475871e-03,
   1.00533756e-02, 1.81550671e-02, 1.96955767e-02, 6.44448736e-03,
  -3.00779549e-03, 1.79257958e-02, 1.03741755e-02, 1.10043844e-02,
   2.20219688e-02],
 [-2.80534839e-04,-4.82434221e-04, 1.06738983e-03, 1.16745535e-02,
   7.93659675e-03, 8.94271092e-03, 3.66174962e-03,-1.72227325e-03,
  -1.67627535e-03, 1.96622257e-01, 4.96886552e-01, 1.97590586e-01,
  -2.89874352e-03, 2.61820455e-02,-4.65489848e-03,-8.82118207e-03,
  -4.34801729e-03, 3.90871269e-03,-1.48762637e-03,-1.11631024e-03,
   5.26492956e-04, 9.73204022e-03,-1.46552745e-03, 9.07748052e-03,
   2.22596134e-02, 1.20283016e-02, 6.41560997e-03, 6.87087392e-03,
   2.28987643e-03,-6.33636820e-02,-3.23570768e-01,-5.01335071e-02,
   3.27242062e-03, 1.24728895e-02, 3.58374852e-03, 1.50413363e-02,
   1.44676836e-02,-5.62658512e-03, 1.05967008e-02, 1.14828239e-02,
   1.68675426e-02],
 [-2.59570764e-03, 3.36283435e-03, 1.62283569e-02, 1.41628872e-03,
   1.09865304e-02, 5.23159148e-03, 1.15393841e-04,-1.10713273e-02,
   5.59588357e-03, 1.01165371e-03, 2.00123364e-01, 5.06118358e-01,
   1.96998233e-01, 1.09913566e-02, 6.24165675e-03,-4.78058323e-03,
   1.70682071e-03, 7.22473523e-03, 4.53390948e-03, 5.18481824e-03,
   4.65168104e-03, 2.62327513e-02, 1.10179088e-02, 1.49022332e-02,
   1.30244340e-02, 7.21716168e-03, 9.08624521e-03, 1.87891444e-02,
   1.18559266e-03, 2.05689275e-02,-5.06288287e-02,-3.43853194e-01,
  -5.81557694e-02, 9.36561331e-03,-6.08640570e-04, 1.03935031e-02,
  -1.11629603e-03, 7.92828171e-03, 3.98110601e-03, 1.34099546e-02,
   1.02219841e-02],
 [ 5.24139693e-03, 6.18490080e-03, 1.71859599e-02,-5.38885100e-03,
   1.64233487e-02, 3.54864613e-03,-9.81568092e-03,-7.06947949e-03,
  -1.21860493e-03,-1.23119511e-02, 5.33083914e-03, 2.07026576e-01,
   5.06700491e-01, 1.98445169e-01, 2.21500123e-03, 9.34680719e-03,
   4.35413314e-03, 1.55780809e-02,-6.53111917e-04,-9.28461518e-04,
   4.15439634e-03, 1.35234829e-02, 2.22467699e-02, 1.44915236e-02,
   1.22915574e-02, 1.36633068e-03, 7.29422282e-03, 1.41972457e-02,
   1.27340088e-02, 1.85902134e-02, 6.71200582e-03,-4.94739232e-02,
  -3.26778058e-01,-3.99346102e-02, 2.15002174e-03, 2.36158355e-02,
   5.70361259e-03, 1.59901169e-02, 2.86465365e-04, 1.70413870e-02,
   1.70902805e-02],
 [ 6.68861376e-03, 2.25535017e-03, 2.31616037e-03, 1.17809260e-03,
  -4.64213017e-03,-3.70446917e-03, 2.24052594e-03,-7.81236265e-03,
  -1.41101429e-02,-5.64711216e-03,-2.54454889e-03,-3.69219219e-03,
   2.02913178e-01, 4.96435413e-01, 1.98425410e-01,-3.93207169e-03,
  -9.76587795e-03, 1.27412161e-03,-5.73379679e-03,-7.31923554e-03,
   5.00619547e-03,-6.16023156e-03, 1.48728237e-02, 1.50139382e-02,
   1.29950944e-02, 1.64152764e-02, 1.44983291e-02, 7.07771949e-03,
   3.93991242e-03, 4.80368152e-03, 2.07251440e-02,-2.22175644e-03,
  -5.65774483e-02,-3.33732356e-01,-5.89536787e-02, 9.92004954e-03,
   1.64208323e-02, 9.79106228e-03, 1.27648026e-02, 1.75352018e-02,
   1.81197359e-02],
 [-3.30337433e-03, 1.08561615e-02, 3.90806155e-03,-1.43147200e-03,
  -1.40916812e-02, 3.18230756e-03,-2.48879136e-03, 4.73045870e-03,
  -8.29885117e-03, 1.08183031e-03, 3.31434322e-03, 5.51187918e-03,
  -1.77629781e-02, 1.88977577e-01, 5.04245864e-01, 1.86780888e-01,
   2.42590334e-04, 5.08847408e-03,-1.23959897e-03,-3.37075907e-03,
   3.35809096e-03, 1.13262317e-02,-1.42995246e-03,-1.96691406e-04,
   9.42656322e-03, 9.71638569e-03, 1.40611336e-02, 9.13926557e-03,
   5.69488095e-03, 1.13998304e-02, 1.72479303e-02, 9.08962763e-03,
   5.61954669e-03,-4.34303090e-02,-3.33314502e-01,-5.55447239e-02,
   6.11587260e-03, 1.09006485e-02, 3.18100801e-03,-9.24721903e-04,
   1.20895072e-02],
 [-2.84179527e-03, 1.41406375e-02,-2.39007063e-03, 1.22472650e-02,
   1.01980754e-02, 3.00693464e-03,-1.89768043e-04,-4.51675443e-03,
  -2.70698527e-03, 3.67692376e-03,-5.85593631e-03, 5.99785930e-03,
  -1.02894958e-02,-1.49224535e-03, 2.00399498e-01, 4.97111152e-01,
   2.08452866e-01, 1.02920275e-02,-1.89330337e-04, 3.95373669e-03,
   7.62702555e-03, 8.78298728e-03, 1.68940283e-03, 1.57480766e-02,
   9.56928812e-03, 7.35084327e-03, 1.24242991e-02, 1.87578519e-02,
   2.13693210e-02, 6.63458791e-03, 2.71408119e-02, 4.66016740e-03,
   7.54666486e-03, 2.05973908e-02,-5.66482814e-02,-3.42073326e-01,
  -6.45620854e-02, 1.41820310e-02, 9.28026262e-03, 2.90015404e-03,
   1.01215777e-02],
 [ 3.29156629e-03, 2.57837555e-03,-1.97571156e-03,-9.17473683e-04,
   2.35476367e-03, 5.34535959e-03,-7.24389639e-03, 1.08693562e-02,
   5.07604755e-03, 1.97437915e-03, 1.38130618e-02,-7.26456467e-03,
  -9.92563333e-04,-1.92835102e-03, 7.49021810e-03, 2.00391544e-01,
   5.01221598e-01, 2.02873121e-01,-4.76197454e-03,-5.21491517e-04,
   1.12139831e-02, 5.86423206e-03, 8.85990136e-03, 1.25941419e-02,
   1.65564761e-02,-3.94687773e-03, 8.42581664e-03, 1.32463091e-02,
   7.02653671e-03, 1.90689689e-03, 1.41314807e-02, 8.79395680e-03,
   1.01723206e-02, 2.29347814e-02, 9.15106814e-03,-5.51537708e-02,
  -3.38497297e-01,-4.17248642e-02, 6.95490064e-03, 2.37510570e-02,
  -1.74969787e-03],
 [-1.66646042e-03,-8.21832396e-04, 2.05899245e-03,-7.00202921e-03,
   8.78848944e-03,-1.09033156e-02,-9.04975500e-03, 3.48357640e-03,
   1.52524235e-03,-1.10693887e-02, 3.82304429e-03,-9.81520634e-04,
  -8.88840102e-03,-1.44183577e-02,-2.40904187e-03,-4.71897698e-03,
   1.98051810e-01, 5.01607997e-01, 1.96815954e-01,-1.60764490e-02,
  -2.97104491e-03, 8.28170405e-03, 1.00723507e-02, 8.38444051e-03,
   1.07650250e-02, 1.61382125e-03, 1.36506570e-02, 6.78992761e-04,
   3.43912036e-03, 1.46876330e-02, 2.91180739e-02, 1.33917761e-02,
   5.27062743e-03, 7.56471701e-03, 5.29845485e-03, 1.12837457e-02,
  -6.57323910e-02,-3.32424876e-01,-5.01102358e-02, 1.43351816e-02,
   8.49595312e-03],
 [ 4.12049995e-03, 3.30203431e-03, 3.12877219e-03,-6.59277909e-03,
   3.66615604e-03, 6.72042932e-03, 2.19065946e-03,-8.75805432e-03,
   1.20408927e-02,-1.93571241e-03,-9.47593999e-03, 5.12892122e-03,
  -5.56342386e-04,-7.73456271e-03,-4.47542569e-03,-1.73013850e-03,
  -2.46877403e-04, 2.11359905e-01, 5.01110158e-01, 2.04856695e-01,
   3.07127715e-03,-7.98625091e-03, 2.82692600e-03, 1.76883852e-02,
   6.29952775e-03, 1.11113011e-02, 7.33559553e-03,-1.76284521e-04,
  -4.73627383e-03, 1.41234594e-03, 2.60721872e-02, 1.83107398e-02,
   1.80452043e-03,-1.39273705e-03,-4.93584399e-05, 1.42044932e-02,
  -4.11746915e-03,-5.22634227e-02,-3.32584935e-01,-4.25166625e-02,
   1.13295731e-02],
 [ 1.44568194e-03,-6.79673048e-03, 7.62390480e-03,-2.30263214e-03,
  -1.03305247e-02, 1.01760757e-02, 3.05902771e-03,-1.25853506e-02,
   5.37064415e-03,-1.21469720e-03, 1.59442066e-03, 5.40272645e-03,
   3.71582489e-03,-3.24565694e-03, 6.30716593e-04,-1.80681414e-03,
   1.37256666e-03, 9.28339097e-03, 2.00653827e-01, 5.08450929e-01,
   1.89151672e-01,-3.29824065e-03, 5.20982995e-03, 1.78033104e-02,
   1.24166912e-02, 8.38706808e-03, 2.11574707e-02, 5.72735473e-03,
   1.09141152e-02, 7.30360727e-03, 2.27888597e-02, 6.96814000e-03,
   6.05562982e-03, 9.13833493e-03, 1.11193500e-02, 1.44932476e-02,
   1.18224375e-02, 1.18437995e-02,-5.52800207e-02,-3.28003286e-01,
  -5.74551076e-02],
 [ 1.56932377e-03,-5.97415941e-03, 1.17456712e-03,-1.07714305e-02,
  -9.02436991e-03, 6.13443200e-03, 6.19915868e-03,-8.41588385e-03,
  -1.13933833e-02, 8.46011822e-03, 2.02196526e-02,-8.15948336e-03,
  -1.91449577e-04, 1.82993938e-03, 3.28963091e-03,-6.47902731e-05,
   9.04707694e-03, 9.55828081e-03, 5.47931101e-03, 2.01691180e-01,
   4.93869212e-01, 1.00042134e-02,-8.21152460e-03, 1.21639871e-02,
   1.77857875e-02, 1.52924959e-02, 1.44609875e-02, 9.37480644e-03,
   5.82309852e-03, 1.43573832e-02, 5.47221977e-03, 1.00762047e-02,
   1.37018559e-02, 1.12090581e-02, 1.43111256e-02, 2.01024965e-02,
   1.09756950e-02, 8.68250418e-03, 7.34347043e-03,-6.37173269e-02,
  -3.22891184e-01]])
        
        # Initialize the start observation
        self._old_ob = np.array(10 * np.ones(self.dimension))
        self._current_step = 0
        self._done = False

    def action_spec(self):
        return self.action_space

    def observation_spec(self):
        return self.observation_space

    def _reset(self):
        self._current_step = 0
        self._old_ob = np.array(10 * np.ones(self.dimension))
        self._done = False

        return self._old_ob.copy()

    def _step(self, action):
        action = np.clip(action, -1., 1.)

        # decide whether to reset the model
        if self._done:
            self._reset()
        feature = np.hstack(([1],self._old_ob,action))
        # get the observation
        ob = np.dot(self.transition, feature) + np.random.multivariate_normal(mean=self.mean, cov=self.identity)

        # get the reward
        reward = self.reward(
            {'end_state': ob, 'start_state': self._old_ob, 'action': action}
        )

        # get the end signal
        self._current_step += 1

        info = {}
        info['reward'] = reward
        info['current_step'] = self._current_step

        if self._current_step >= self._env_info['max_length']:
            done = True
            self._done = True
        else:
            done = False
            self._done = False

        self._old_ob = ob.copy()
        return ob, reward, done, info

    def reward(self, data_dict):
        # TODO: Change the reward like let the reward be small
        return -0.05 * (np.linalg.norm(data_dict['start_state']) ** 2)


# env_name = 'IVVI'
# environment = env(env_name, 123, {'reset_type': 'gym'})
# tf_env = tf_py_environment.TFPyEnvironment(environment)
# print(isinstance(tf_env, tf_environment.TFEnvironment))
# print("TimeStep Specs:", tf_env.time_step_spec())
# print("Action Specs:", tf_env.action_spec())




