# coding=utf-8
# Copyright 2021 The Google Research Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""Training and evaluation in the online mode."""
from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import collections
import os
import time
from typing import Any

from absl import logging

import gin
import numpy as np
import tensorflow.compat.v1 as tf
from brac import dataset
from brac import policies
from brac import train_eval_utils
from brac import utils
from mbbl.env import env_register
import random
from tf_agents.environments import tf_py_environment
from tf_agents.environments import py_environment
from tf_agents.environments import tf_environment
from tf_agents.specs import array_spec
from tf_agents.trajectories import time_step as ts
from tf_agents.environments import utils
from gym.spaces import box


class env(py_environment.PyEnvironment):

    def get_info(self) -> Any:
        pass

    def get_state(self) -> Any:
        pass

    def set_state(self, state: Any) -> None:
        pass

    def __init__(self, env_name, rand_seed, misc_info):
        self._env_name = env_name
        self._seed = rand_seed
        self._npr = np.random.RandomState(self._seed)
        self._misc_info = misc_info
        self._env_info = env_register.get_env_info(self._env_name)
        self.dimension = 20
        # self._action_spec = array_spec.BoundedArraySpec(
        #     shape=(), dtype=np.int32, minimum=-1, maximum=1, name='action')
        # self._observation_spec = array_spec.BoundedArraySpec(
        #     shape=(), dtype=np.int32, minimum=-100, maximum=100, name='observation')
        self.action_space = box.Box(low=-1.0, high=1.0, shape=(self.dimension,), dtype=np.float32)
        self.observation_space = box.Box(low=-np.inf, high=np.inf, shape=(self.dimension,), dtype=np.float32)
        self.P = 0.5 * np.eye(self.dimension) + np.diag(0.2 * np.ones(self.dimension-1),k=1) + np.diag(0.2 * np.ones(self.dimension-1),k=-1)
        self.Q = 0.5 * np.eye(self.dimension) + np.diag(0.1 * np.ones(self.dimension-1),k=1) + np.diag(0.1 * np.ones(self.dimension-1),k=-1)
        self.mean = np.zeros(self.dimension)
        self.identity = np.eye(self.dimension)

# z = 0.7

    
#         self.transition = np.array([[ 5.63374216e-03, 5.13647333e-01, 1.92519611e-01, 6.42439574e-03,
#   1.26665155e-02,-2.48591135e-04,-7.46198700e-03, 2.77713358e-03,
#   5.08373259e-03, 9.79407603e-04, 4.72723469e-03, 4.16838723e-03,
#   8.56250850e-03, 1.77230182e-02, 1.51843908e-02,-8.58144385e-04,
#   -4.81615988e-04, 1.18687679e-02,-1.46807679e-03,-2.72334313e-03,
#   1.48146414e-02,-2.69725336e-01,-4.03263766e-02, 1.46784192e-02,
#   2.18962275e-02, 2.14839571e-02, 9.26975718e-03, 2.12777450e-02,
#   2.24053391e-02, 2.12789771e-02, 2.13554902e-02, 1.63558629e-02,
#   1.76287284e-02, 2.48799599e-02, 1.62528583e-02, 3.17311370e-02,
#   1.62379215e-02, 1.65726695e-02, 1.23948740e-02, 1.96340922e-02,
#   2.42814119e-02],
#  [ 2.52851718e-03, 2.08733268e-01, 5.08919130e-01, 2.01408250e-01,
#   1.23162320e-02,-8.67838189e-03,-1.10784913e-02,-1.85916386e-03,
#   -2.92299768e-03, 8.40068048e-03,-3.88928609e-03, 2.22492975e-03,
#   -7.74600791e-03, 1.42697837e-02, 3.29600432e-03,-5.30574474e-03,
#   -9.46101555e-03, 2.87273042e-03, 1.06262057e-02, 8.20932494e-03,
#   9.06338912e-04,-3.17176229e-02,-2.77404758e-01,-2.54961165e-02,
#   1.45875476e-02, 7.76819053e-03, 1.38437698e-02, 1.90952895e-02,
#   1.99113765e-02, 2.10973512e-02, 2.18817277e-02, 1.44439447e-02,
#   2.57820878e-02, 2.27732914e-02, 1.72667461e-02, 2.65453390e-02,
#   2.52915112e-02, 2.45568866e-03, 2.57770280e-02, 9.16910752e-03,
#   2.85943660e-02],
#  [ 4.94136553e-03,-2.66414351e-04, 1.87345744e-01, 4.99487512e-01,
#   1.98206381e-01,-1.78221756e-03,-1.04487645e-02,-8.22682393e-03,
#   -6.14208496e-03,-4.94353296e-03,-7.01174127e-03,-3.08006083e-03,
#   -1.06722822e-02, 5.92100880e-03, 6.45518632e-03,-1.13063654e-02,
#   -1.60358003e-02, 2.87900326e-03,-1.53332110e-02, 1.08102203e-02,
#   3.67063917e-04, 1.34619055e-02,-3.53283534e-02,-2.71733623e-01,
#   -3.94837499e-02, 1.99754625e-02, 2.58034320e-02, 1.83682791e-02,
#   1.80834724e-02, 1.41498578e-02, 2.05480121e-02,-2.06276563e-03,
#   1.41609455e-02, 3.00198064e-02, 7.94514423e-03, 2.70800577e-02,
#   1.70733900e-02, 1.20303613e-02, 2.94396699e-02, 2.16050559e-02,
#   1.57077959e-02],
#  [-3.99885061e-03,-2.41589983e-03,-7.04670825e-03, 1.97512976e-01,
#   5.00189555e-01, 2.07858269e-01,-1.52980003e-02, 2.87606839e-03,
#   4.83895861e-03, 4.70250985e-03, 4.05723963e-03, 4.47118434e-03,
#   4.07974954e-03, 1.04709396e-03, 1.11607289e-02,-8.02029867e-03,
#   -1.32267614e-03, 2.04682546e-03, 2.02634343e-04,-1.22495518e-02,
#   -9.09479694e-03, 2.04140815e-02, 6.22306336e-03,-3.51576914e-02,
#   -2.80443509e-01,-4.21149650e-02, 1.95388758e-02, 3.02080977e-02,
#   1.43183967e-02, 1.95690146e-02, 2.71405236e-02,-4.13216642e-03,
#   2.41286139e-02, 1.68061365e-02, 1.60083128e-02, 1.49409230e-02,
#   1.45530302e-02, 1.53149797e-02, 2.12897679e-02, 2.07474486e-02,
#   2.57784565e-02],
#  [-8.56035419e-03, 6.02420734e-03,-6.61526435e-03, 4.90095263e-03,
#   2.19714633e-01, 5.09455194e-01, 2.11021877e-01,-4.38927611e-03,
#   1.77138365e-03, 1.14357445e-03,-4.19248349e-03, 4.00289372e-03,
#   2.30579347e-02, 3.60874890e-03, 1.04177896e-02, 3.25516648e-03,
#   2.11704273e-03,-9.55451707e-03, 5.09163183e-03,-1.77155395e-03,
#   -1.25299067e-02, 2.27164725e-02, 1.03590335e-02, 8.22793436e-03,
#   -3.07927095e-02,-2.82821704e-01,-3.43526401e-02, 9.07042044e-03,
#   1.70137409e-02, 1.83281416e-02, 2.67403530e-02, 2.05053870e-03,
#   2.49746713e-02, 1.58014216e-02, 2.13112745e-02, 2.39989252e-02,
#   4.49033026e-03, 1.61107603e-02, 3.20280925e-02, 8.45892268e-03,
#   2.09186263e-02],
#  [ 4.92161268e-03, 1.42101855e-02,-1.47064643e-02,-1.12351515e-02,
#   9.26993643e-03, 1.99015102e-01, 5.18505584e-01, 2.02810305e-01,
#   3.71145418e-03, 1.99652514e-03,-3.35677716e-03, 1.98929797e-03,
#   9.50957435e-03, 4.21087378e-03,-7.60199241e-03,-1.19327295e-03,
#   6.21462848e-03, 3.30289294e-03, 5.79529565e-03, 5.38351770e-03,
#   -1.09824625e-02, 1.30177300e-02, 1.29576726e-02, 4.11632600e-03,
#   4.86424714e-03,-3.31148528e-02,-2.81545017e-01,-4.61728982e-02,
#   1.33184360e-02, 2.19985227e-02, 1.05256273e-02, 1.64220265e-02,
#   1.76569696e-02, 2.16785042e-02, 9.91423357e-03, 2.49711727e-02,
#   1.20818132e-02, 2.36915522e-02, 1.80253785e-02, 1.80444381e-02,
#   2.77967928e-02],
#  [-1.62688491e-03, 4.97553064e-03,-1.22113796e-02,-1.55154779e-02,
#   -1.11896542e-02,-1.66011096e-02, 1.97392575e-01, 5.07798615e-01,
#   1.99056683e-01, 8.05991087e-03, 2.91807937e-03,-7.57117877e-03,
#   -1.83757709e-03,-6.27682923e-03,-3.11688303e-03,-4.97337605e-03,
#   1.32590433e-02, 1.67663404e-03,-1.26029037e-02, 2.78110564e-03,
#   7.68995978e-03, 1.23394086e-02, 2.90255184e-02, 2.56435839e-02,
#   1.47096207e-02, 2.70386697e-02,-4.20670316e-02,-2.89525788e-01,
#   -4.83430360e-02, 8.65812783e-03, 1.40635383e-02, 1.04608988e-02,
#   1.22571365e-02, 2.07462372e-02, 7.77579171e-03, 2.13830103e-02,
#   1.71253516e-02, 3.30763470e-02, 2.08012319e-02, 1.16726138e-02,
#   2.74512343e-02],
#  [-5.53299295e-03, 1.55701333e-02,-2.11016219e-02,-2.98382112e-03,
#   -8.85084968e-03, 7.50733243e-03,-5.60716195e-03, 2.00028596e-01,
#   5.11127033e-01, 2.07045274e-01,-1.93483257e-03,-1.01791705e-03,
#   1.53756831e-03,-2.55442971e-02, 1.63235462e-02, 5.56322367e-03,
#   -1.25023795e-03, 1.30475299e-02,-3.44438778e-03, 8.80476351e-03,
#   -3.58445481e-03, 1.53748828e-02, 1.48210760e-02, 2.03214391e-02,
#   8.09086350e-04, 2.40679270e-02, 6.82921996e-03,-3.92010773e-02,
#   -2.89930236e-01,-5.28829708e-02, 3.67262134e-03, 1.00005871e-02,
#   1.15974480e-02, 2.82776280e-02, 2.86567415e-02, 1.47281177e-02,
#   2.16107592e-02, 2.74550613e-02, 1.32682535e-02, 9.65554425e-03,
#   2.58457649e-02],
#  [ 4.00629756e-03, 1.35463460e-02,-1.22249755e-02,-7.08625264e-03,
#   -1.95524688e-03,-1.24304981e-02,-1.85347896e-02,-4.99598162e-03,
#   1.95365699e-01, 4.86934413e-01, 1.85997391e-01, 9.08087660e-03,
#   -3.29083606e-03,-1.52420035e-02, 4.06108618e-03,-9.21623993e-04,
#   -5.89542959e-03,-6.48735965e-03, 3.33760939e-03, 7.49349375e-03,
#   -4.08372824e-03, 1.70916946e-02, 1.07649875e-02,-9.65963494e-04,
#   1.12396845e-02, 9.16866615e-03, 1.82211652e-02, 1.22522739e-04,
#   -4.47710039e-02,-2.95991671e-01,-3.59004627e-02,-2.87899390e-03,
#   4.14269531e-03, 2.73089007e-02, 1.87219529e-02, 2.93832709e-02,
#   2.25545009e-02, 2.00771785e-02, 9.29645414e-03, 1.78394545e-02,
#   1.87999027e-02],
#  [ 2.38311540e-03, 1.38836848e-02, 8.77110976e-03, 1.95063217e-03,
#   -6.18668705e-03,-4.70103909e-03,-7.00045248e-03,-7.36848812e-04,
#   4.00050676e-03, 2.02151737e-01, 5.04025223e-01, 2.04663471e-01,
#   1.16341107e-02,-1.12294112e-02, 1.03819504e-03,-8.02486843e-03,
#   2.66687540e-03, 4.01802076e-03, 1.51272400e-03, 5.63219046e-03,
#   6.18367959e-03, 1.55972601e-02, 2.23450204e-02, 2.49644483e-02,
#   2.46726665e-02, 4.61454323e-03, 1.44781206e-02, 1.83293480e-03,
#   6.51550453e-03,-4.33698060e-02,-2.83218799e-01,-3.49542700e-02,
#   1.14594291e-03, 1.57693527e-02, 1.43254279e-02, 2.65173671e-02,
#   2.82278230e-02, 1.26877067e-02,-6.69363715e-03, 2.00556399e-02,
#   2.24586388e-02],
#  [-8.58392059e-03, 6.24313363e-03, 6.58236101e-03, 1.48189351e-02,
#   2.15276784e-03, 6.22766801e-03, 3.76729969e-03,-4.87230659e-03,
#   5.10259295e-03, 1.36014998e-03, 1.96277058e-01, 5.01520956e-01,
#   2.03622127e-01, 2.74053932e-03, 1.15973740e-02, 8.17449333e-03,
#   -1.62863586e-03, 7.70330323e-03,-6.91734602e-03, 8.53045495e-04,
#   1.50114612e-02, 2.47827855e-02, 2.42132755e-02, 2.25824083e-02,
#   2.10473696e-02, 2.12489195e-02, 1.03386677e-02, 1.51572051e-02,
#   1.12096208e-02, 1.66700818e-02,-3.47319586e-02,-2.83037364e-01,
#   -3.27596174e-02, 5.09221281e-03, 1.09412370e-02, 2.65519612e-02,
#   2.97446958e-02, 1.32158678e-02, 5.54109705e-03, 1.26774944e-02,
#   1.39245328e-02],
#  [ 1.32761076e-03, 3.00000355e-03,-1.96950287e-02, 1.23041555e-02,
#   1.48152150e-02, 1.68910562e-02,-1.06878158e-02, 2.90610663e-03,
#   9.98488283e-03, 1.80813614e-03, 5.14373450e-03, 1.96272002e-01,
#   5.07589027e-01, 1.90543320e-01,-7.89702181e-04, 2.83742930e-03,
#   -4.59399052e-03, 5.04003126e-03,-2.06199568e-02, 9.79043215e-03,
#   -5.64986861e-03, 9.89376273e-03, 2.11008651e-02, 1.11188738e-02,
#   1.69341216e-02, 2.03473599e-02, 1.82242343e-02, 1.35895311e-02,
#   1.70262104e-02, 1.57069319e-02, 2.42478931e-02,-4.08797126e-02,
#   -2.88421141e-01,-4.67050164e-02, 7.70803804e-03, 2.52244916e-02,
#   1.80672670e-02, 1.42282364e-02, 1.51087055e-02, 1.40587319e-02,
#   2.17207228e-02],
#  [ 4.69192470e-04,-9.88673801e-03,-7.65357482e-03, 7.68169135e-03,
#   1.39145460e-02,-2.81605931e-03, 7.98904375e-04, 6.54302497e-03,
#   -4.40840945e-03, 6.92116097e-03,-5.56969711e-04, 4.03195098e-03,
#   2.09733732e-01, 5.01006951e-01, 1.87792168e-01, 9.68070054e-04,
#   1.63806420e-03, 3.16191522e-03,-1.20166514e-03,-1.18830673e-02,
#   4.16642608e-03, 7.19304637e-03, 1.77642614e-02, 1.06820492e-02,
#   1.10835000e-02, 1.81002528e-02, 2.26024413e-02, 2.19020029e-02,
#   2.42193476e-02, 1.91984846e-02, 2.29047459e-02, 3.19066444e-03,
#   -3.47153058e-02,-2.91621574e-01,-4.48354506e-02, 2.88460446e-02,
#   1.36356985e-02, 1.37991295e-02, 1.22592756e-02, 1.49759441e-02,
#   1.70347741e-02],
#  [-7.52725483e-03,-1.43574147e-02,-3.13893198e-03, 9.58392838e-04,
#   9.25700053e-03,-5.83259920e-03, 2.80308898e-03,-5.38392277e-03,
#   -7.57867785e-03, 1.10321952e-02, 4.25686154e-03,-1.12132428e-02,
#   5.09923837e-03, 2.03167872e-01, 5.15763820e-01, 1.98058454e-01,
#   2.89102439e-03, 1.06520863e-02, 3.37905271e-03,-2.39496701e-04,
#   4.11683417e-03, 1.13661395e-02, 2.34850285e-02, 2.22858431e-02,
#   7.42011984e-03, 1.18247876e-02, 2.30101258e-02, 1.92292489e-02,
#   1.11587110e-02, 2.47396059e-02, 2.07577229e-02, 2.66354778e-02,
#   1.61264616e-02,-5.22115153e-02,-2.83808259e-01,-3.15205426e-02,
#   7.89079743e-03, 8.85980042e-03, 2.52256239e-02,-4.16340888e-03,
#   1.71277547e-02],
#  [ 1.74227119e-03,-5.82041383e-03,-8.09286362e-03,-9.88260734e-03,
#   -3.25726531e-03,-1.11240567e-02, 8.66021786e-03, 3.46994706e-03,
#   8.25460402e-03, 1.08211096e-02, 2.33604148e-03, 3.85153936e-03,
#   1.00213522e-02, 1.20565444e-02, 1.98148356e-01, 5.11465731e-01,
#   1.97175107e-01,-5.81529918e-04, 1.31297051e-02, 3.11992819e-03,
#   1.57910511e-02, 1.88179547e-02, 1.73672605e-02, 1.36664608e-02,
#   1.12456661e-02, 1.86977908e-02, 1.01429993e-02, 1.52428912e-02,
#   1.36550751e-02, 1.42128694e-02, 3.02062456e-02, 1.33189037e-02,
#   1.84701822e-02,-1.00734093e-03,-4.07938370e-02,-2.65995688e-01,
#   -3.95606771e-02, 9.63173906e-03, 2.73184740e-02, 2.77709334e-03,
#   2.55521324e-02],
#  [ 2.52090506e-03, 7.37358762e-03, 3.99676300e-04, 3.99540601e-03,
#   -3.73481978e-04, 7.62482621e-03, 1.44744324e-03, 5.13038595e-03,
#   -1.99776507e-03,-7.63925904e-03, 4.65880300e-03, 1.30052421e-02,
#   2.25782971e-03,-2.22091297e-03,-8.99288300e-03, 1.94061152e-01,
#   4.98746191e-01, 1.95155002e-01, 2.03755701e-03,-1.52953519e-03,
#   8.70587903e-03, 3.17703745e-02, 6.33798802e-03, 6.32098839e-03,
#   1.80516132e-02, 1.78418853e-02, 2.17293904e-02, 7.91695963e-03,
#   1.95901008e-02, 2.12688383e-02, 2.04604087e-02,-3.59891215e-03,
#   1.52509177e-02, 1.63874398e-02, 1.49027677e-02,-3.26665724e-02,
#   -2.91084813e-01,-4.76662629e-02, 1.35186450e-02, 1.21862729e-02,
#   3.26574547e-02],
#  [-1.41623529e-02, 7.44537111e-03,-2.24515301e-04, 2.69633377e-03,
#   4.99748101e-03, 3.46416753e-03,-1.03318961e-03, 9.75845271e-03,
#   2.46708079e-04,-5.11203793e-04, 6.00205713e-03, 5.22113915e-03,
#   1.42615679e-02,-4.12317801e-03, 1.57471477e-02,-5.60529491e-03,
#   1.98784618e-01, 5.03558317e-01, 1.99667178e-01, 1.36915366e-03,
#   -4.86131016e-03, 3.50083919e-02, 4.89392528e-03, 1.15678073e-02,
#   1.79608175e-02, 1.50001233e-02, 2.23298606e-02, 1.90397599e-02,
#   1.28754455e-02, 2.62501977e-02, 3.05457985e-02, 1.53916600e-02,
#   1.71051031e-02, 3.44587291e-02, 1.37796165e-02, 2.64047702e-02,
#   -3.48988673e-02,-2.93355112e-01,-4.17949302e-02, 1.48546494e-02,
#   2.25694855e-02],
#  [ 2.06201229e-03, 1.89225670e-03, 4.04194171e-03,-7.07576352e-03,
#   -7.47928017e-03,-4.27809192e-03, 7.12497355e-04,-1.03784577e-03,
#   -1.13827339e-02,-1.40243064e-02,-1.02610937e-02,-8.16109922e-03,
#   2.18709228e-03, 2.84417261e-03, 3.87483129e-03, 5.11142828e-03,
#   4.79261486e-03, 1.93236381e-01, 5.11120515e-01, 2.02154461e-01,
#   2.85302427e-03, 2.37233460e-02, 1.47815870e-02, 1.93653677e-02,
#   9.98437737e-03, 1.37175018e-02, 1.33690253e-02, 1.44937113e-02,
#   1.96853775e-02, 3.01830734e-02, 2.25626223e-02, 2.48348052e-02,
#   1.35672503e-02, 2.46905570e-02, 7.88050364e-03, 2.02916756e-02,
#   9.43000383e-03,-3.93314055e-02,-2.83564685e-01,-3.94509647e-02,
#   1.17098242e-02],
#  [ 2.46160345e-03, 6.89169108e-03, 4.87181518e-03,-1.40470618e-02,
#   4.95779915e-03, 2.76125807e-03,-6.34509970e-03, 5.57387223e-04,
#   -1.13896483e-02,-7.04596246e-03, 5.69388605e-03,-1.07779702e-02,
#   -6.69206569e-03,-5.72211336e-03,-6.19924396e-04,-5.73747240e-03,
#   7.43983465e-03,-1.91713257e-02, 2.09048417e-01, 4.95288475e-01,
#   2.06192692e-01, 8.65905326e-03, 1.76423297e-02, 2.32902386e-02,
#   7.15272895e-03, 2.36958871e-02, 1.69057601e-02, 1.60736805e-02,
#   1.83453666e-02, 2.08787491e-02, 2.11486579e-02, 2.71940755e-02,
#   2.21172926e-02, 1.28223249e-02, 8.58253756e-03, 2.04779901e-02,
#   1.97731777e-02, 2.42235651e-02,-2.48163244e-02,-2.79826945e-01,
#   -3.89877516e-02],
#  [-9.90088217e-04,-2.14379722e-03, 1.24037913e-02, 2.09262650e-02,
#   6.43040859e-03, 1.63271407e-02, 6.10833717e-03, 2.25556758e-03,
#   -9.45987070e-03,-3.26028143e-05, 3.07703655e-03, 1.70933291e-04,
#   -9.41357559e-03,-1.32366567e-02, 1.71691325e-02,-3.03586116e-04,
#   -2.68540472e-03,-7.63880316e-05, 4.08033236e-03, 1.88574474e-01,
#   5.02354766e-01, 1.62980880e-02, 1.56879695e-02, 2.54925792e-02,
#   1.87501766e-02, 1.92715582e-02, 1.87438294e-02, 1.43351647e-02,
#   5.72631831e-04, 2.41653968e-02, 2.64145397e-02, 3.14543767e-02,
#   1.25171643e-02, 4.69726512e-03, 4.66510592e-03, 2.06297916e-02,
#   2.24085367e-02, 1.17639667e-02, 1.37549039e-02,-4.34891353e-02,
#   -2.84440799e-01]])
  
  
        self.transition = np.array([[ 2.67468770e-03, 4.98692824e-01, 2.00600189e-01, 1.86593706e-03,
  -1.13906445e-02, 5.24778380e-03,-1.38546470e-02,-4.53559688e-03,
  -1.52404133e-02, 4.64542603e-03,-3.61307431e-03,-8.43452690e-04,
   7.13903297e-03,-4.48909413e-03, 1.16174714e-02, 7.18236918e-04,
   9.36918518e-03,-3.53894209e-03,-1.46711539e-02,-4.08134034e-03,
  -3.48250363e-03,-2.70397397e-01,-3.09356395e-02, 2.90028484e-02,
   1.78903698e-02, 8.31537351e-03, 2.11110688e-02, 3.37517877e-02,
   6.96305181e-03, 2.89979709e-02, 1.82074003e-02, 1.22884093e-02,
   1.54237243e-02, 2.26067768e-02, 1.36933050e-02, 3.22644926e-02,
   2.61736754e-02, 1.52159858e-02, 7.71338139e-03, 2.31445575e-02,
   8.15994371e-03],
 [-7.95501266e-03, 2.01453023e-01, 4.92340705e-01, 2.04328578e-01,
  -1.20498376e-03, 1.81629262e-03,-1.69406510e-03, 9.30964431e-03,
  -1.92376579e-03, 3.29710908e-03,-8.71375504e-03, 7.25558080e-03,
  -2.40237202e-04,-5.09061724e-03,-5.41828408e-03, 7.37049210e-03,
   7.49150010e-03,-1.21236366e-02,-8.37518497e-03, 5.83659988e-03,
  -2.48979935e-03,-3.69739667e-02,-2.73868723e-01,-2.86026264e-02,
   2.55164343e-02, 2.10110526e-02, 1.75452003e-02, 3.18812537e-02,
  -8.85912270e-04, 1.50651086e-02, 1.80006807e-02, 1.50181985e-02,
   1.72656952e-02, 1.97276387e-02, 1.30044620e-02, 1.92616930e-02,
   3.48033560e-02, 1.69337177e-02, 1.29338248e-02, 2.16580132e-02,
   6.30261779e-03],
 [-1.55645236e-02, 3.71745040e-03, 1.98723995e-01, 5.00032723e-01,
   2.03017162e-01,-1.25667598e-02, 1.42027185e-03, 8.83688682e-03,
   1.04721746e-02,-2.77363813e-03,-2.95977276e-03, 9.64206140e-03,
   6.70095366e-03,-1.06571981e-02,-5.26805234e-03,-9.01394243e-04,
  -5.81398419e-04,-3.79659037e-04,-1.30289323e-02, 1.09563982e-02,
   2.46372654e-03, 1.83434516e-02,-2.98742694e-02,-2.84080951e-01,
  -2.55404711e-02, 1.61337419e-02, 3.39601392e-02, 2.90478614e-02,
   1.63434724e-02, 1.78516392e-02, 2.43021799e-02, 1.44118107e-02,
   1.60999549e-02, 2.59050803e-02, 1.77277888e-02, 2.30119614e-02,
   3.71207854e-02, 1.15015957e-02, 5.82710707e-03, 2.00140905e-02,
   1.90315775e-02],
 [-1.02550548e-02,-1.10364197e-03,-9.94459194e-03, 1.97011902e-01,
   5.01496365e-01, 1.93569191e-01, 9.75394465e-03, 1.31441201e-03,
  -1.86462590e-03,-4.33795621e-03,-2.74199484e-03, 5.02451301e-03,
   5.63296223e-03, 2.44393056e-03, 1.11349200e-02,-7.45518435e-03,
  -1.05367761e-03, 1.54493685e-02,-1.30453099e-03,-5.79115653e-03,
  -4.28709939e-03, 1.52117317e-02, 6.88198486e-03,-4.56058239e-02,
  -2.85191115e-01,-3.31314163e-02, 1.73489997e-02, 2.28110092e-02,
   1.54190052e-02, 1.21153592e-02, 3.88846599e-02, 1.90132060e-02,
   8.47792952e-03, 1.87136088e-02, 1.81147332e-02, 3.22383707e-02,
   1.53021138e-02, 1.58472622e-02, 1.13676472e-02, 1.81868945e-02,
   1.81029527e-02],
 [ 5.66300562e-03,-3.19848734e-03,-1.40200792e-03,-3.42866941e-03,
   1.92586662e-01, 4.97743087e-01, 2.04424889e-01,-9.60337931e-03,
  -2.27845756e-03, 7.42895085e-03, 7.47647763e-03,-1.28788806e-03,
   4.59235328e-03, 1.11737205e-02, 1.26889541e-02,-8.76080133e-04,
   9.95830200e-04, 2.97145790e-03,-3.60590874e-03, 1.33391041e-03,
   9.20369537e-03, 2.18389443e-02, 1.87368446e-02, 8.63069973e-03,
  -4.55863929e-02,-2.78191706e-01,-4.87512541e-02, 1.17967452e-02,
  -2.22545650e-03, 2.24817264e-02, 3.93626116e-02, 2.39666093e-02,
   1.20076850e-02, 1.56922752e-02, 1.40450853e-02, 3.88762790e-02,
   2.88371502e-02, 2.04108219e-02, 5.04554345e-03, 1.11674516e-02,
   1.85616485e-02],
 [ 2.48359324e-03, 6.51752984e-03,-3.59249171e-03, 1.05718333e-02,
  -1.54893277e-02, 2.02900906e-01, 5.07992960e-01, 2.00363248e-01,
  -7.85695015e-03,-5.05064722e-03,-1.33344643e-03,-5.49404777e-03,
  -1.10090730e-02, 7.89189819e-03,-2.95061517e-03,-8.15176352e-03,
  -3.18597421e-03,-6.19895762e-03, 2.09104646e-03,-2.93544115e-03,
  -1.40523695e-04, 3.29286234e-02, 2.34803561e-02, 1.13855157e-02,
   1.01899161e-02,-3.08467893e-02,-2.67445410e-01,-3.93355909e-02,
   6.54979254e-03, 1.94601755e-02, 2.50324004e-02, 2.44375263e-02,
  -1.73974323e-03, 3.50033427e-02, 2.50360592e-02, 2.50703232e-02,
   2.24079881e-02, 2.56090535e-02, 1.13348008e-02, 9.63884430e-03,
   5.02241352e-03],
 [-4.06156394e-03, 4.38938981e-03,-1.47466084e-02,-1.26476060e-02,
   8.13465939e-03,-2.78856344e-03, 1.99775980e-01, 5.04886252e-01,
   1.95850203e-01, 3.89358690e-03,-7.84694553e-03,-1.36197580e-03,
   7.56222388e-03, 6.73740412e-03,-8.44735562e-05, 2.99000848e-03,
  -6.66911394e-03, 7.80920451e-03,-7.90297515e-03, 9.36163330e-03,
   6.34500848e-03, 2.89083673e-02, 3.07872323e-02, 1.32088715e-02,
   1.08556694e-02, 2.47712565e-02,-2.94937650e-02,-2.81023054e-01,
  -2.45379086e-02, 9.74576600e-03, 1.09994099e-02, 2.09737858e-02,
   1.45581278e-02, 2.32139082e-02, 9.82487309e-03, 1.73654091e-02,
   3.24421913e-02, 3.03214153e-02, 3.45309372e-02, 3.20846596e-02,
   2.51761012e-02],
 [-4.74668666e-03, 1.90103892e-04,-6.22883412e-03, 3.39003532e-04,
  -3.96267511e-03,-5.88003457e-04,-5.05594768e-03, 2.02260119e-01,
   4.98386422e-01, 1.97127208e-01,-8.29076943e-03, 8.00394271e-04,
  -6.53308917e-03, 1.35847528e-02, 7.34221876e-03,-8.32413774e-03,
   4.08439523e-03, 1.32962515e-02,-5.68890390e-04, 7.90100561e-03,
   1.91889518e-04, 2.87832662e-02, 2.66143239e-02, 3.16605084e-02,
   2.63987688e-02, 2.86407897e-02, 2.53686420e-02,-3.37426928e-02,
  -2.71522020e-01,-2.94207219e-02, 2.20463332e-02, 2.11064862e-02,
   6.65989845e-03, 1.86298207e-02, 1.95558456e-02, 9.93829731e-03,
   3.24484212e-02, 1.94545498e-02, 2.77079758e-02, 9.62738270e-03,
   1.77472138e-02],
 [-2.85211858e-03,-1.79969574e-03,-1.79189830e-04, 5.95111610e-04,
   2.40971150e-03, 1.00017143e-03, 7.58565808e-03,-4.17147491e-03,
   1.96576203e-01, 5.03264841e-01, 1.94160946e-01,-1.40235451e-03,
  -1.24224535e-02, 1.74996000e-04,-1.29127099e-03,-1.39896231e-02,
  -3.02760821e-03,-4.35564631e-03, 5.92677382e-03, 8.45722179e-03,
  -7.62393226e-03, 1.92162914e-02, 2.33478396e-02, 1.46368180e-02,
   1.13366282e-02, 1.01059124e-02, 1.11448454e-02, 2.15658950e-02,
  -5.15338644e-02,-2.80678284e-01,-4.27052879e-02, 1.54877518e-02,
   1.99510706e-02, 1.89982481e-02, 2.30964546e-02, 9.30322540e-03,
   2.45931995e-02, 1.56313474e-02, 1.85642911e-02, 5.32260144e-03,
  -2.06485996e-03],
 [ 7.31659835e-03,-9.52756594e-03,-5.99195195e-03,-7.35112735e-04,
  -6.20868602e-03, 1.16338677e-03,-1.78524578e-03, 4.13497184e-03,
   1.49309302e-02, 1.98850450e-01, 5.06741454e-01, 2.03105609e-01,
   2.33597226e-03, 2.07426601e-03, 6.67965548e-03, 9.05408681e-03,
   2.02915635e-03, 8.92190808e-03, 6.01979902e-03,-2.06358838e-03,
   3.63245980e-03, 1.80755959e-02, 1.80156257e-02, 6.86410995e-03,
  -4.08747462e-03, 8.58603124e-03, 4.00049921e-03, 2.39823801e-02,
   3.42747882e-03,-3.07568720e-02,-2.78919465e-01,-2.16793057e-02,
   1.83022726e-02, 9.20657072e-03, 6.26318231e-05, 1.86573526e-02,
   3.01224451e-02, 1.50758402e-02, 8.21233713e-03, 1.75446913e-02,
   5.81504134e-03],
 [ 2.17602154e-03,-2.58175311e-03,-7.41769087e-03,-9.57765376e-04,
  -3.55534933e-03,-5.92224713e-03,-5.30863716e-03,-6.03852598e-03,
   1.52214357e-02,-1.43173253e-02, 2.00680311e-01, 5.01081760e-01,
   2.05694990e-01, 9.90283334e-03, 9.72773711e-03, 4.15654770e-03,
   5.53844239e-03, 3.79996956e-03, 6.66729166e-03,-1.30851742e-02,
   4.58550092e-03, 2.08037608e-02, 1.98739749e-02, 1.63548703e-02,
   1.56979830e-02, 2.34180316e-02, 7.46809104e-03, 1.35449513e-02,
   1.77237448e-02, 2.44508045e-02,-5.73019556e-02,-2.86444091e-01,
  -4.12609773e-02, 2.27144114e-02, 5.83973928e-03, 1.48467887e-02,
   2.62705995e-02, 4.64910617e-04, 1.51850396e-02, 2.25223568e-02,
   8.55089625e-03],
 [-8.20775010e-03,-3.33345683e-04,-1.93210019e-03,-7.98241597e-03,
  -1.69305398e-02, 1.15296063e-02, 6.41491439e-03,-8.28623602e-03,
   7.02803711e-03, 1.38082974e-02,-7.44532688e-03, 1.96627073e-01,
   5.11845711e-01, 2.06374464e-01, 6.09656633e-03,-3.58077069e-03,
   1.02044922e-02,-1.10456619e-02,-5.44877064e-04, 4.31083061e-03,
  -1.15687712e-02, 2.59216062e-02, 3.41096217e-02, 9.19590271e-03,
   1.76385307e-02, 3.12467999e-02, 1.83857039e-02, 1.84738272e-02,
   1.04421400e-02, 1.45183244e-02, 1.26853917e-02,-4.52944534e-02,
  -2.90060031e-01,-3.75759541e-02, 1.43987400e-02, 2.08149238e-02,
   1.92415123e-02, 1.67396893e-02, 1.60390947e-02, 2.59045449e-02,
   6.75145316e-03],
 [ 1.78354240e-03, 1.00570262e-02,-1.54190143e-03,-5.97235151e-03,
  -5.78570028e-03,-4.40190227e-04, 1.09469611e-02, 3.48160978e-03,
   3.01525465e-03, 1.29541975e-02,-2.78352595e-03,-1.23402283e-02,
   2.01752882e-01, 4.99856262e-01, 2.03401072e-01, 1.59198566e-03,
  -8.60030080e-03, 1.65670074e-02, 7.04608949e-03, 6.23469627e-03,
  -1.29813399e-02, 2.99657416e-02, 2.45910056e-02, 1.93516141e-02,
   1.43816071e-02, 2.22728584e-02, 1.96564734e-02, 2.46270963e-02,
   1.84848486e-02, 3.38375893e-02, 1.80410536e-02, 2.41925811e-02,
  -4.17013628e-02,-2.81785700e-01,-4.24435287e-02, 3.39295450e-02,
   2.22045345e-02, 1.31316781e-02, 4.10919223e-03, 1.27252776e-02,
   9.83824209e-03],
 [-3.28734991e-03,-5.48771927e-03, 5.04944809e-04,-4.75081769e-03,
  -1.07952118e-02, 6.92521297e-03,-4.10895675e-03,-8.15896800e-04,
  -1.02514520e-02, 2.33638603e-03,-6.69910355e-03, 6.42074775e-03,
   2.72347998e-03, 1.84172617e-01, 4.99766061e-01, 2.02775700e-01,
  -1.73118334e-02,-3.63542917e-04, 3.65636116e-03,-1.62738200e-03,
  -9.29428897e-03, 1.88221434e-02, 2.09155548e-02, 2.16111298e-02,
   1.78034713e-02, 2.10404539e-02, 1.39432703e-02, 2.52298064e-02,
   6.24820189e-03, 8.97413192e-03, 3.15186426e-02, 1.95465669e-02,
   2.84475407e-02,-3.67220271e-02,-2.73941535e-01,-2.66426208e-02,
   2.72099242e-02, 7.20200436e-03, 1.11057867e-02, 1.69183859e-02,
   1.12356881e-02],
 [ 7.63625360e-03,-2.16227807e-03, 9.04135703e-03,-7.28901827e-03,
  -1.90901770e-02, 1.01271626e-02,-7.52714720e-04, 2.17291190e-02,
  -5.93256218e-03, 2.76816858e-03,-1.19341354e-03,-2.80360096e-03,
   3.00040828e-03, 2.39326907e-03, 2.01616684e-01, 4.97191860e-01,
   1.90074934e-01,-6.60872481e-03, 7.58046454e-03,-2.68361363e-03,
  -1.19768263e-02, 2.33731175e-02, 3.07609281e-02, 1.68642391e-02,
   1.64386249e-02, 1.89959966e-02, 1.80971997e-02, 2.83836809e-02,
   1.81791674e-03, 7.95849485e-03, 2.01852787e-02, 3.46704898e-02,
   1.97006834e-02, 1.23783619e-02,-2.90834232e-02,-2.82714040e-01,
  -2.18651925e-02, 1.56070177e-02, 1.30571972e-02, 3.56826661e-04,
   1.91941158e-02],
 [ 9.28445546e-03, 1.59524403e-03, 1.92751994e-02,-1.82055016e-03,
  -2.08457128e-03,-2.66092547e-03,-1.14907922e-02,-7.22133363e-03,
   6.20365449e-04, 7.71265089e-03,-1.26645203e-02, 1.76207222e-03,
   1.00886328e-02, 6.21864117e-03, 5.90797893e-03, 2.00294954e-01,
   5.12834648e-01, 2.04839458e-01, 3.06699845e-04,-1.91929538e-03,
   2.07052208e-03, 2.31160309e-02, 2.77839506e-02, 1.34761168e-02,
   1.98746882e-02, 1.85349483e-02, 1.86548258e-02, 2.32361549e-02,
   5.52544184e-03, 6.58161171e-03, 1.33195871e-02, 2.33622227e-02,
   1.95960827e-02, 3.08212882e-02, 1.90172734e-02,-4.83425102e-02,
  -2.69999252e-01,-3.82721685e-02, 1.14146931e-02, 1.50433499e-02,
   2.41010903e-02],
 [-5.92247243e-03, 8.08724725e-03, 4.08167069e-04,-1.09879240e-02,
  -1.67102374e-03, 4.72211751e-04, 4.59970970e-03,-1.21563410e-04,
   3.58259773e-03, 6.39973044e-03,-5.17464498e-03,-4.42785433e-03,
  -4.68007286e-03,-1.82397394e-03, 8.23006759e-03, 1.61087914e-02,
   1.96776332e-01, 5.13215741e-01, 1.92075551e-01, 1.16731425e-04,
  -8.84435005e-03, 2.44365357e-02, 1.44758595e-02, 1.32443724e-02,
   1.58958479e-02, 2.04190208e-02, 2.10922171e-02, 2.83226238e-02,
   1.34703112e-02, 1.04194982e-02, 1.08266988e-02, 3.60715112e-02,
   9.76984846e-03, 3.31106092e-02, 2.51360056e-02, 1.82501050e-02,
  -1.78498975e-02,-2.80765462e-01,-4.15500046e-02, 1.66643033e-02,
   2.98208103e-02],
 [ 3.56034494e-03,-2.75784382e-03,-6.41772711e-03,-1.12100172e-02,
   2.80784273e-03, 4.00292744e-04,-4.88032721e-03,-1.99862808e-04,
  -1.17354078e-02,-1.14788804e-03,-6.41517968e-04,-1.41719759e-02,
  -5.43037204e-03, 7.44701755e-03, 1.49207341e-02, 9.30339245e-03,
  -6.41054763e-03, 1.94689889e-01, 4.89215462e-01, 1.94316584e-01,
   3.57565064e-03, 1.85627892e-02, 2.42969360e-02, 2.21373207e-02,
   1.45368419e-02, 1.04759979e-02, 3.43450686e-02, 2.49425355e-02,
   6.90299923e-03, 1.18811726e-02, 2.21878207e-02, 2.69414294e-02,
   1.20382591e-02, 2.14357237e-02, 1.28626246e-02, 2.42494546e-02,
   2.93206568e-02,-3.50897913e-02,-2.84081465e-01,-5.60101276e-02,
   2.11760721e-02],
 [-2.67997565e-03,-8.44851564e-03,-1.50683776e-02,-6.39222875e-03,
   7.47742811e-03, 4.84761571e-03,-4.19221481e-03, 5.65371404e-04,
   4.20690506e-03, 3.61249285e-03,-1.25152009e-02,-7.58493650e-04,
   1.37354972e-03,-1.82152882e-03, 8.05413576e-03,-1.04519586e-02,
   4.51364089e-03,-3.06242662e-03, 1.90039818e-01, 4.94413640e-01,
   1.86093630e-01, 2.19406457e-02, 2.15897734e-02, 1.78601623e-02,
   1.61759078e-02, 7.93363538e-03, 1.48822085e-02, 1.60014730e-02,
   1.15442909e-02, 2.39036851e-02, 2.72369511e-02, 1.19682777e-02,
   3.55675426e-03, 2.09508843e-02, 1.74629549e-02, 1.34983047e-02,
   1.56001605e-02, 3.89861795e-03,-3.11155600e-02,-2.88484491e-01,
  -4.84713566e-02],
 [-1.02080880e-04,-9.40269749e-03,-1.43888734e-03,-7.21349313e-03,
   1.14030499e-03,-4.69130459e-03, 1.28091285e-03,-4.85036744e-03,
  -2.28949034e-03,-3.98055448e-03, 4.10909274e-03,-1.68963311e-03,
   1.53363861e-03, 1.39774218e-03,-6.80669540e-03,-8.28550399e-03,
  -1.49356182e-02,-1.00276751e-02, 1.31918379e-03, 2.00819101e-01,
   5.04382055e-01, 2.25554060e-02, 1.45615286e-02, 1.50195481e-02,
   1.46503094e-02, 1.98682942e-03, 2.66326397e-02, 2.05568481e-02,
   1.04233820e-02, 2.16195001e-02, 1.63430042e-02, 1.87957592e-02,
   1.61727555e-02, 2.32189113e-02, 1.66270598e-02, 1.96355464e-02,
   2.62012970e-02, 1.76581999e-02, 2.96067468e-02,-3.22357812e-02,
  -2.79683703e-01]])
        

        # Initialize the start observation
        self._old_ob = np.array(10 * np.ones(self.dimension))
        self._current_step = 0
        self._done = False

    def action_spec(self):
        return self.action_space

    def observation_spec(self):
        return self.observation_space

    def _reset(self):
        self._current_step = 0
        self._old_ob = np.array(10 * np.ones(self.dimension))
        self._done = False

        return self._old_ob.copy()

    def _step(self, action):
        action = np.clip(action, -1., 1.)

        # decide whether to reset the model
        if self._done:
            self._reset()
        feature = np.hstack(([1],self._old_ob,action))
        # get the observation
        ob = np.dot(self.transition, feature) + np.random.multivariate_normal(mean=self.mean, cov=self.identity)

        # get the reward
        reward = self.reward(
            {'end_state': ob, 'start_state': self._old_ob, 'action': action}
        )

        # get the end signal
        self._current_step += 1

        info = {}
        info['reward'] = reward
        info['current_step'] = self._current_step

        if self._current_step >= self._env_info['max_length']:
            done = True
            self._done = True
        else:
            done = False
            self._done = False

        self._old_ob = ob.copy()
        return ob, reward, done, info

    def reward(self, data_dict):
        # TODO: Change the reward like let the reward be small
        return -0.05 * (np.linalg.norm(data_dict['start_state']) ** 2)


# env_name = 'IVVI'
# environment = env(env_name, 123, {'reset_type': 'gym'})
# tf_env = tf_py_environment.TFPyEnvironment(environment)
# print(isinstance(tf_env, tf_environment.TFEnvironment))
# print("TimeStep Specs:", tf_env.time_step_spec())
# print("Action Specs:", tf_env.action_spec())




