# coding=utf-8
# Copyright 2021 The Google Research Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""Training and evaluation in the online mode."""
from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import collections
import os
import time
from typing import Any

from absl import logging

import gin
import numpy as np
import tensorflow.compat.v1 as tf
from brac import dataset
from brac import policies
from brac import train_eval_utils
from brac import utils
from mbbl.env import env_register
import random
from tf_agents.environments import tf_py_environment
from tf_agents.environments import py_environment
from tf_agents.environments import tf_environment
from tf_agents.specs import array_spec
from tf_agents.trajectories import time_step as ts
from tf_agents.environments import utils
from gym.spaces import box


class env(py_environment.PyEnvironment):

    def get_info(self) -> Any:
        pass

    def get_state(self) -> Any:
        pass

    def set_state(self, state: Any) -> None:
        pass

    def __init__(self, env_name, rand_seed, misc_info):
        self._env_name = env_name
        self._seed = rand_seed
        self._npr = np.random.RandomState(self._seed)
        self._misc_info = misc_info
        self._env_info = env_register.get_env_info(self._env_name)
        self.dimension = 20
        # self._action_spec = array_spec.BoundedArraySpec(
        #     shape=(), dtype=np.int32, minimum=-1, maximum=1, name='action')
        # self._observation_spec = array_spec.BoundedArraySpec(
        #     shape=(), dtype=np.int32, minimum=-100, maximum=100, name='observation')
        self.action_space = box.Box(low=-1.0, high=1.0, shape=(self.dimension,), dtype=np.float32)
        self.observation_space = box.Box(low=-np.inf, high=np.inf, shape=(self.dimension,), dtype=np.float32)
        self.P = 0.5 * np.eye(self.dimension) + np.diag(0.2 * np.ones(self.dimension-1),k=1) + np.diag(0.2 * np.ones(self.dimension-1),k=-1)
        self.Q = 0.5 * np.eye(self.dimension) + np.diag(0.1 * np.ones(self.dimension-1),k=1) + np.diag(0.1 * np.ones(self.dimension-1),k=-1)
        self.mean = np.zeros(self.dimension)
        self.identity = np.eye(self.dimension)
#         self.transition = np.array([[ 4.42289557e-03, 5.15509231e-01, 2.10416565e-01, 9.69888140e-03,
#   -1.11635105e-02, 7.82935968e-03, 8.21956920e-03,-3.83949716e-03,
#   -4.06782230e-03, 4.72030758e-03, 1.14754388e-03,-6.74238570e-03,
#   1.16553636e-02,-1.03069680e-02, 9.34276922e-03,-1.10938951e-03,
#   2.59438743e-03,-8.20449064e-03,-6.76277229e-03, 1.38670674e-02,
#   -2.45685676e-03,-3.64609536e-01,-5.62638611e-02,-6.61090044e-03,
#   -9.94521781e-03,-8.31373227e-03,-4.26057998e-03,-5.81006680e-03,
#   7.87995143e-03, 1.91418454e-02, 1.60006375e-03,-4.67037415e-03,
#   -1.29049430e-03, 4.78698934e-03, 1.03568719e-02, 4.36361634e-03,
#   2.45973763e-02,-3.27896834e-03,-3.54795009e-03, 3.65045913e-03,
#   9.37717510e-03],
#  [ 5.30792545e-03, 2.06776156e-01, 5.13174211e-01, 1.94076916e-01,
#   1.02421144e-02, 1.07578951e-02, 2.73339838e-03,-1.66020042e-02,
#   -1.90196181e-02,-2.40482788e-03, 8.82133777e-03, 1.95470357e-03,
#   3.12464009e-03,-1.41031168e-02, 5.29573742e-03, 3.39147892e-03,
#   -5.58543885e-03,-3.53388003e-03, 2.92585864e-03, 8.88980743e-03,
#   -6.08669299e-04,-6.15272944e-02,-3.78926344e-01,-6.45122081e-02,
#   -4.16741556e-03, 3.28145892e-03, 1.19854051e-02,-3.30379363e-03,
#   8.92106895e-03,-1.06384149e-03,-1.61177463e-03, 3.33689967e-03,
#   -2.99494238e-03, 1.52189933e-02, 1.47802363e-02, 4.27501366e-03,
#   1.55557134e-02, 5.32230384e-03, 2.36393943e-03, 1.28268239e-02,
#   6.73126020e-03],
#  [ 1.59906092e-02, 3.49528680e-03, 1.87207517e-01, 4.94754906e-01,
#   1.83950711e-01, 1.02820103e-02, 7.60858026e-03,-2.62575028e-03,
#   -2.36014868e-03,-3.16898359e-03, 9.36526264e-03,-1.11338289e-02,
#   -1.32297394e-02,-1.80672828e-02,-3.92791642e-03,-3.21769487e-03,
#   -8.09035204e-03, 1.10452088e-02, 1.40845478e-02, 2.96552177e-03,
#   -2.39420981e-05, 1.23688135e-02,-6.29401415e-02,-3.74771306e-01,
#   -6.05403773e-02,-4.21005411e-04, 1.85097184e-03, 1.18791915e-02,
#   2.18190311e-02, 7.80227535e-03, 8.46194909e-03,-2.32108536e-03,
#   8.95911449e-03, 2.31927219e-02, 5.94360069e-03, 9.87945602e-03,
#   8.96639890e-03, 8.51386848e-03,-1.05376383e-02, 2.09058007e-02,
#   -1.92392865e-04],
#  [ 3.56695597e-04,-9.14550028e-04, 1.93691695e-03, 1.95603119e-01,
#   4.95502088e-01, 1.82008914e-01, 1.20226753e-02,-6.96054849e-03,
#   -6.68072261e-03, 8.44822028e-03, 2.19003806e-02,-2.68105967e-03,
#   -1.47089601e-02,-1.34654035e-02, 4.05709706e-03,-9.28817979e-04,
#   -1.06977708e-02,-6.87214917e-03, 7.14368383e-03,-6.20561426e-03,
#   6.99449360e-03,-2.33654612e-03,-1.68016566e-02,-5.50873447e-02,
#   -3.84397968e-01,-6.80077749e-02, 4.43536996e-03, 3.73921505e-03,
#   3.55082163e-03, 1.88728848e-03,-4.99978156e-04, 3.92266217e-04,
#   1.98341568e-02, 6.15728810e-03, 7.22269670e-03, 9.32111452e-03,
#   2.51433499e-03, 1.73499228e-02, 1.57398812e-03,-9.97920345e-04,
#   1.18984590e-02],
#  [-7.42878068e-03, 1.86245335e-03, 6.34941863e-03,-1.40677123e-03,
#   1.89427974e-01, 4.81878550e-01, 1.94642507e-01, 1.17554923e-02,
#   1.92640476e-03, 1.50225876e-02, 8.70442587e-03,-4.25183137e-03,
#   -1.06070554e-02, 5.48073029e-04, 1.57611657e-02,-7.34063709e-03,
#   -5.16960889e-03, 9.92231144e-03, 2.72759277e-03, 1.04259462e-03,
#   5.92825683e-03, 9.00962239e-03, 7.72272735e-04, 2.89692109e-03,
#   -7.03002375e-02,-3.76748734e-01,-7.35016239e-02, 6.71100387e-03,
#   3.52888002e-04,-3.75360746e-04, 8.83316650e-03, 1.25015115e-02,
#   1.60948005e-02, 1.51208930e-02, 5.60144546e-03,-5.87638123e-03,
#   1.39626685e-02, 1.33092280e-02, 1.13031212e-02,-7.12852306e-03,
#   -9.10585964e-03],
#  [-5.60680973e-03, 7.17756518e-03,-5.85507324e-03,-3.10514473e-03,
#   -7.95386876e-03, 1.91976276e-01, 4.88355400e-01, 1.83487785e-01,
#   -1.08197796e-02, 4.96267359e-03,-2.45886103e-04,-6.96856975e-03,
#   1.00304379e-02, 6.85755677e-03, 6.78953815e-03,-9.89509161e-03,
#   -1.27488105e-02, 8.41328011e-03, 6.38929531e-03, 8.66746311e-03,
#   -2.18143119e-03,-1.23321532e-04, 1.66248005e-02, 1.66475647e-02,
#   7.85249835e-03,-5.03809561e-02,-3.84755670e-01,-7.33630468e-02,
#   1.45016434e-02, 7.93602837e-03, 1.96417537e-02,-1.06736752e-02,
#   5.56745679e-03, 1.84188043e-03, 1.84811709e-02, 6.77794943e-03,
#   -7.96507281e-03, 7.03302948e-03, 5.26905988e-03,-7.25359497e-04,
#   7.79151118e-03],
#  [-4.13048660e-03, 3.34393685e-03,-3.87304231e-03,-1.21617006e-02,
#   -5.83074549e-03, 1.57142991e-03, 1.98682705e-01, 4.87567780e-01,
#   2.14893867e-01, 1.16668183e-02, 4.80659074e-03,-6.43682941e-03,
#   -2.44863611e-03,-1.32689207e-03, 4.00615618e-03, 7.65414318e-03,
#   -1.42849193e-02,-1.72342308e-03,-2.15310963e-03, 1.41527760e-02,
#   1.64366812e-03, 2.97186760e-03,-4.23682653e-03, 1.46429788e-02,
#   -5.01337855e-03, 4.29225708e-03,-7.59124966e-02,-3.72912974e-01,
#   -7.04819971e-02, 9.66262131e-03, 4.12579302e-03, 1.87916118e-03,
#   9.83310707e-03, 2.15751284e-03, 2.61384297e-02, 5.09463357e-03,
#   2.06440620e-02,-3.31070584e-03, 4.82203497e-03, 3.80754636e-03,
#   1.22518235e-02],
#  [-1.60366943e-03,-4.05073572e-04,-3.13414186e-03,-6.36235802e-03,
#   -1.31626753e-02, 1.02371499e-02, 1.91667374e-02, 1.83860367e-01,
#   4.91283721e-01, 1.99205822e-01,-6.35526109e-03,-5.91424096e-03,
#   9.09089113e-04,-1.13023310e-02, 8.66299404e-04,-5.57955073e-03,
#   -7.17553164e-03,-3.05591579e-03,-2.65615709e-04,-5.14209891e-03,
#   8.83954805e-03, 9.05073506e-03,-3.87760131e-03,-8.97272612e-04,
#   8.75898391e-03, 7.34798725e-03,-7.69560057e-04,-6.90101486e-02,
#   -3.79416928e-01,-7.03771120e-02, 1.17532712e-02, 1.08306025e-02,
#   1.17063310e-02,-9.36643198e-03, 1.63582967e-02, 1.10969937e-02,
#   1.41830852e-02, 1.22209048e-02, 2.41800030e-02, 1.71811355e-02,
#   1.43621249e-02],
#  [-3.85645396e-03, 2.57051925e-03, 1.77291608e-03, 3.22320915e-03,
#   1.97223012e-02,-6.72014231e-04, 9.39206365e-03,-1.44215312e-02,
#   1.82447734e-01, 5.09793487e-01, 2.06296995e-01,-8.81183090e-03,
#   6.81031938e-03,-4.18507485e-03, 7.36579196e-03,-2.72435070e-03,
#   -7.92914073e-03,-4.09928145e-03,-7.24783689e-03,-3.63905826e-03,
#   2.07712161e-03, 8.63691766e-03, 4.46362478e-03, 1.29781142e-02,
#   9.78957507e-03, 1.27887586e-02, 1.07805616e-02,-1.81723947e-03,
#   -7.38904801e-02,-3.88721031e-01,-7.66768721e-02,-1.14191295e-03,
#   2.01367369e-02,-5.84465732e-04, 1.85325538e-02, 8.17180358e-03,
#   3.48618476e-03, 3.78024860e-03, 7.86794121e-03, 9.84461674e-03,
#   1.03457708e-02],
#  [ 4.04504236e-03, 1.24446503e-03, 2.73726811e-03, 2.38357195e-03,
#   3.04363059e-02, 1.10911972e-02, 1.57246853e-02, 2.33848925e-03,
#   -3.35314846e-03, 1.92624189e-01, 5.00937820e-01, 1.94454479e-01,
#   -2.89104133e-03, 1.16396448e-02, 4.95906843e-03, 2.10069306e-02,
#   -9.25160699e-03, 2.85818429e-03,-8.42775485e-03,-8.50752565e-03,
#   -6.48592646e-03, 1.55510177e-02,-2.94918507e-03, 1.39560914e-02,
#   1.37583805e-02, 3.93531864e-03, 2.62157431e-03, 1.86273117e-03,
#   1.01803485e-02,-7.07742968e-02,-3.82392218e-01,-6.05137099e-02,
#   1.34780841e-02, 1.36956079e-02, 9.25620209e-03, 8.34645238e-03,
#   1.16471580e-02, 1.04393433e-02,-2.55702445e-03, 2.96037417e-03,
#   7.72497153e-03],
#  [-1.01370641e-02,-5.31065192e-03,-1.05313794e-02,-5.97472278e-03,
#   8.10644371e-04,-1.27004862e-03, 7.39795827e-04, 1.15145684e-02,
#   5.79139850e-03,-2.03175002e-02, 1.93348953e-01, 4.98236668e-01,
#   1.86388822e-01, 6.37914837e-03, 6.38785551e-03, 8.56652805e-03,
#   -8.31927978e-04, 3.13361265e-03, 1.63306613e-04,-6.89001891e-03,
#   -2.53240244e-03, 4.76346530e-03, 7.72672129e-03, 1.93959514e-03,
#   1.45477876e-02, 6.27855856e-03, 4.35899954e-03, 1.13795899e-02,
#   8.60691412e-03, 7.78405126e-04,-5.69345595e-02,-3.76475526e-01,
#   -7.28284900e-02, 2.46812303e-04,-2.56146981e-05, 9.63596879e-03,
#   6.56973678e-03, 3.79869836e-03, 7.46397609e-03, 6.53733852e-03,
#   2.01939183e-02],
#  [-2.12641679e-03,-6.28793311e-03,-2.96990133e-03,-5.56792060e-03,
#   2.19081122e-03, 7.12967528e-04,-1.89245684e-03, 6.29301893e-03,
#   -1.10424170e-03,-2.08360048e-02,-2.74416864e-03, 2.07816008e-01,
#   4.86926899e-01, 1.92431450e-01, 2.85799057e-03, 1.22915731e-02,
#   1.55369304e-03, 2.91448853e-04,-1.40793962e-02,-3.03377170e-03,
#   -3.88109916e-03,-2.35549715e-03, 6.94637819e-03, 1.56687671e-02,
#   -6.79061134e-03, 6.20473165e-03, 1.53428132e-02, 6.17863507e-03,
#   8.39855281e-04,-3.87638171e-03, 4.98574259e-03,-6.90718099e-02,
#   -3.81618414e-01,-5.83037452e-02, 7.60167087e-04, 2.85063762e-03,
#   2.73538491e-02,-7.65063979e-03, 5.72851621e-03,-1.49481882e-03,
#   1.95131841e-02],
#  [-5.36169155e-04,-4.35495543e-04,-3.90945346e-03,-4.14692954e-03,
#   -3.82364579e-03, 6.90514752e-03,-4.86412069e-03,-1.40409399e-02,
#   2.89479232e-03,-8.24525589e-03,-1.64610135e-02, 1.03749082e-02,
#   1.93092620e-01, 4.95576764e-01, 2.14399696e-01,-8.29600451e-03,
#   1.40005464e-03,-5.69659276e-03,-7.72180331e-03,-6.72969715e-03,
#   1.75269306e-03, 3.40504101e-03, 3.04935613e-03, 3.68086218e-03,
#   -1.59059153e-03, 1.02303048e-02, 2.13297109e-02, 6.08532973e-04,
#   9.84963564e-03, 4.98106896e-03,-1.07226844e-02, 3.56979217e-03,
#   -6.73948834e-02,-3.74692165e-01,-6.06641261e-02,-2.43761535e-03,
#   1.52596300e-02, 1.03138095e-02,-1.43139138e-03,-4.29691480e-04,
#   1.78939803e-03],
#  [-1.53618264e-02, 2.51560303e-03,-2.27465675e-03,-9.40919957e-03,
#   5.33373147e-03,-5.09343159e-03,-2.21864995e-02,-7.44804496e-03,
#   7.96162111e-03, 7.90687393e-03,-1.98261676e-02, 4.83887623e-03,
#   -2.95869231e-03, 1.99711835e-01, 5.04587672e-01, 1.84989287e-01,
#   8.26262600e-03,-1.42865084e-03,-3.89700155e-03,-1.75941283e-02,
#   -3.86347073e-03, 1.19549020e-02, 1.55883903e-02, 6.45215149e-04,
#   5.00260984e-03, 1.46878900e-02, 1.21233922e-03,-6.10130174e-03,
#   1.07985714e-02, 6.46734228e-03, 1.84712770e-02, 6.53563426e-03,
#   -4.96564865e-03,-6.07122663e-02,-3.83882208e-01,-7.27988999e-02,
#   8.42707491e-03, 1.80429694e-03, 1.42256776e-02, 8.05166313e-03,
#   3.65604913e-03],
#  [ 6.89200141e-04, 6.45891164e-03, 2.06678200e-03,-1.29852481e-03,
#   1.70704619e-02, 1.09555094e-02,-8.90522204e-03,-1.12022690e-03,
#   2.51082257e-03, 5.96967263e-03,-6.78174156e-03, 2.02263530e-03,
#   2.31183513e-03, 1.00784114e-02, 2.00440747e-01, 5.00071905e-01,
#   2.01387906e-01, 1.56155119e-03,-1.25998142e-02,-2.12979691e-03,
#   -5.94156403e-03, 7.90136598e-03, 3.36513574e-03, 1.34233968e-02,
#   6.85972696e-03, 8.80167390e-03, 4.35270884e-03,-3.66180845e-03,
#   -2.14497981e-03,-9.27261797e-03, 1.60709050e-02, 1.34499170e-02,
#   3.73957132e-03, 2.67327525e-02,-7.90503133e-02,-3.79401761e-01,
#   -6.52889871e-02, 1.02057026e-02, 1.54044310e-02, 3.19895022e-03,
#   -2.15208311e-03],
#  [-6.11249027e-03,-3.79888170e-03, 8.61767354e-03,-1.18768715e-02,
#   -3.05286510e-03, 6.06704754e-03,-1.00602784e-02,-5.03308679e-03,
#   -2.51525218e-03, 6.63055072e-03,-3.24463143e-03, 1.30768622e-02,
#   1.62922696e-02, 1.46229533e-02,-1.39050475e-02, 1.92030953e-01,
#   5.07317499e-01, 1.89952197e-01,-2.97075764e-03,-6.64606366e-03,
#   -3.13169743e-03,-1.77880610e-02,-1.47789622e-02, 1.26996682e-02,
#   -1.33066847e-03, 7.43305014e-03, 3.91718987e-03, 2.54148542e-03,
#   7.64709403e-04,-1.48025073e-03, 8.66632149e-03, 3.53782513e-03,
#   9.32162358e-03, 1.93167612e-02,-3.32188041e-03,-7.62918898e-02,
#   -3.81265241e-01,-6.32003790e-02,-3.42081370e-03, 7.30555775e-03,
#   4.06467899e-03],
#  [-1.58492560e-02,-8.14506232e-03, 2.94389564e-03,-3.01719416e-03,
#   1.16193737e-02, 4.78426296e-03,-4.97751912e-03, 5.83926305e-03,
#   -7.67604280e-03, 1.64988326e-02,-6.86239276e-03, 8.30851026e-03,
#   1.39161759e-04, 1.91756987e-02,-2.42999796e-03,-5.70027162e-03,
#   2.05968796e-01, 5.02476303e-01, 1.94300090e-01, 2.93670354e-03,
#   1.07263659e-03,-4.22917720e-03,-1.63956573e-02, 1.90988554e-02,
#   5.92597483e-03, 9.61599104e-03, 6.63805597e-03,-1.94437227e-03,
#   1.33713795e-03, 2.75052306e-03, 1.15942785e-02, 1.38793692e-02,
#   5.13564177e-03, 6.38325573e-03, 4.50142796e-03, 3.37790407e-03,
#   -5.41218030e-02,-3.71242562e-01,-7.36727436e-02, 1.02638081e-02,
#   2.36773834e-02],
#  [-8.73572478e-03,-3.26293075e-03, 3.04888466e-04, 3.46747486e-03,
#   2.48538838e-03, 4.53964722e-05, 4.46070791e-03,-3.82949145e-03,
#   -6.58507469e-03, 4.81764417e-03,-3.95748963e-03,-1.90741865e-02,
#   1.17075196e-03, 8.61935203e-03,-7.50782746e-03, 3.34745485e-03,
#   9.17118376e-03, 2.08254773e-01, 4.99698951e-01, 1.96807433e-01,
#   -5.44405487e-03, 5.69460133e-03,-6.73561657e-03, 1.93532819e-02,
#   1.51626667e-02, 1.37780030e-02,-4.68038110e-03, 3.32743970e-03,
#   1.49060917e-02, 3.06677460e-03, 3.34109399e-03, 6.35148850e-03,
#   2.49591775e-03, 2.61446948e-03,-3.03489906e-03, 1.11471605e-03,
#   1.47327404e-02,-6.52313807e-02,-3.85227404e-01,-5.91435698e-02,
#   -6.02062036e-03],
#  [-7.85745507e-03,-1.22317542e-03, 7.51991120e-03, 1.49038015e-03,
#   -9.23719739e-03,-4.85837557e-04, 1.36214707e-02, 5.21344611e-05,
#   4.55122936e-03,-1.62872161e-02, 7.35008720e-03,-1.49873843e-02,
#   -2.69831949e-03, 6.86574068e-03, 9.79304397e-03, 9.04708803e-03,
#   8.73074785e-03, 1.97854931e-03, 2.18488442e-01, 5.04542608e-01,
#   2.00232188e-01, 1.00007833e-02, 1.33271542e-02, 1.01536653e-02,
#   2.09037933e-02, 1.81618758e-02, 1.28712227e-03,-2.61013022e-03,
#   1.39180442e-02,-9.10491434e-04, 9.23565089e-03,-2.43162569e-03,
#   2.74334153e-03, 1.52225306e-02, 2.70929135e-04,-2.69394406e-03,
#   4.07703219e-03, 1.07356503e-02,-6.50419984e-02,-3.83596556e-01,
#   -6.06027287e-02],
#  [ 5.05997017e-03, 5.91507345e-03, 1.26988458e-02,-4.91346491e-04,
#   6.28864917e-03, 1.22201417e-02,-4.84594183e-03, 7.71181095e-03,
#   1.02218992e-02, 1.36399904e-02, 5.67704310e-03,-5.61875534e-04,
#   1.75358479e-02, 1.85426043e-02,-3.92167484e-03, 1.96010734e-02,
#   1.28870526e-02, 7.09751058e-03, 6.46749810e-03, 1.90860536e-01,
#   5.02199560e-01,-1.11509978e-04, 1.01760802e-02, 1.73445899e-02,
#   9.15490704e-03, 4.30647349e-03, 1.65868594e-02, 1.56048141e-02,
#   -1.43832840e-03,-1.14656455e-02,-9.29905681e-04, 2.15532231e-03,
#   1.30609143e-02, 1.33614132e-02, 3.34721140e-03, 1.05795590e-02,
#   2.82517762e-03, 1.60216734e-02, 8.41968292e-03,-7.80356151e-02,
#   -3.73151982e-01]])
  
        self.transition = np.array([[ 1.58871809e-03, 5.03104581e-01, 2.00573942e-01,-2.10948989e-03,
  -1.09261303e-03, 1.18616630e-02, 7.01216379e-03,-1.93367599e-03,
   1.20764186e-02, 1.27404346e-02, 9.60042118e-03,-1.55991856e-02,
   6.14863714e-03, 2.30810391e-03, 9.85737083e-03,-1.24098386e-03,
  -4.26563437e-03,-1.00692160e-02, 1.94085084e-02, 2.01124690e-03,
   1.35829714e-02,-3.81919528e-01,-6.57367095e-02, 9.28696037e-03,
  -5.61588218e-03, 3.68924519e-03, 2.59471546e-03, 1.61044811e-04,
  -3.31500989e-03, 4.91155884e-04, 6.93993571e-03, 9.24345202e-04,
   1.70510293e-02, 1.11224249e-02,-8.48956921e-04, 7.76659837e-03,
   7.62505447e-03, 5.87949229e-03, 1.93752306e-02, 1.77770771e-02,
   2.26859381e-04],
 [-1.24237056e-02, 2.03452984e-01, 5.06052266e-01, 2.04822799e-01,
  -3.73024966e-03, 2.15667670e-03,-2.52243451e-03, 1.72880327e-02,
   1.26277012e-02,-7.72024911e-04, 8.03698680e-03, 1.25960225e-02,
   2.64584384e-03,-8.71597995e-03, 3.38265396e-03, 6.07379997e-03,
  -1.13415756e-02,-1.59615812e-02,-2.24600847e-04,-1.11421600e-02,
   4.19665391e-03,-6.65749195e-02,-3.77869915e-01,-7.65974841e-02,
   2.06212770e-03,-3.16992639e-03, 4.17350685e-03, 3.23754454e-03,
   2.82346630e-03, 4.81553125e-03, 1.12750506e-03,-9.44051027e-03,
   8.79397084e-03, 1.17157431e-02,-1.16857735e-02, 7.37476267e-03,
   5.99531447e-03, 2.63466653e-02,-4.25884374e-03, 7.05287509e-03,
   9.23023717e-03],
 [-7.14872355e-03, 6.22397090e-04, 2.10198162e-01, 4.99146744e-01,
   1.93439835e-01,-1.86285422e-02,-5.57458089e-04,-7.31790506e-03,
  -3.33141532e-03,-9.31591281e-04, 4.06490382e-03, 5.39399235e-03,
  -6.41019679e-03,-3.32476884e-03, 3.85003798e-03,-4.51073967e-03,
   2.34513709e-03, 6.88724780e-03,-1.08783471e-02,-1.03602336e-03,
   9.39785755e-03, 6.93322357e-03,-7.17015802e-02,-3.78789157e-01,
  -7.85659690e-02,-3.60697661e-03,-7.29435436e-03, 1.03994598e-03,
   1.32266238e-02, 7.72572731e-03, 1.17156691e-02,-7.57902419e-03,
   2.04399951e-03,-3.31425906e-03,-3.38854280e-03, 4.49242551e-03,
   1.11678540e-02, 2.52150294e-02, 4.84479667e-04, 7.30111700e-03,
   3.43114330e-03],
 [-7.92336697e-04, 7.44571636e-03,-1.38569637e-03, 1.92407108e-01,
   4.96923811e-01, 1.92042951e-01, 6.99927135e-03, 4.84174020e-03,
  -5.61393849e-03,-4.17302903e-03,-1.31586337e-02, 6.77407416e-03,
  -1.00260103e-02,-6.42000887e-03, 2.27386758e-03,-3.57549445e-03,
   7.65621540e-03, 1.08677921e-02, 5.75511191e-03, 2.50214205e-03,
   1.08844524e-03, 3.99617408e-03, 5.03613509e-03,-6.45497566e-02,
  -3.89965059e-01,-6.85506971e-02, 1.30693880e-02,-1.32491713e-02,
   1.50079772e-02, 8.80589214e-03, 2.31192054e-03,-1.83179712e-02,
  -7.00073610e-03, 8.75706201e-04, 1.15835937e-02, 1.56520911e-02,
   4.20332809e-03,-1.14537316e-03,-1.12446161e-03, 1.20298048e-02,
   2.15209333e-03],
 [ 8.54396768e-04, 3.98458181e-03,-1.47057184e-02, 3.43398952e-03,
   1.92328641e-01, 5.14512210e-01, 2.02938969e-01, 9.89089689e-03,
  -5.56165461e-03, 1.22989603e-03,-5.10819055e-03, 1.08206255e-02,
  -8.65586049e-04,-1.33705684e-02, 1.08935693e-02,-1.95863655e-03,
  -8.58414721e-03, 8.38595903e-03,-4.47266296e-03,-5.12798598e-03,
   2.54233972e-03, 1.82196503e-02, 2.18405199e-03,-1.51008020e-02,
  -6.90864116e-02,-3.71354902e-01,-6.34424227e-02,-9.86313698e-03,
   5.97432935e-03, 7.28888298e-03, 5.01699769e-04, 5.95855225e-03,
   2.18944350e-03, 4.03376266e-03,-2.12746837e-06, 1.58450253e-02,
   9.07636473e-03, 4.50843880e-03,-4.38241137e-03, 4.08163656e-03,
  -1.03108320e-02],
 [-9.74056940e-03, 9.66571880e-03,-7.32127401e-03, 1.91407633e-04,
  -2.85504036e-03, 2.01749505e-01, 4.87277957e-01, 1.88005813e-01,
  -1.34982117e-03, 8.94419824e-03, 1.10609631e-02,-8.88109813e-04,
   8.33569384e-03,-2.42141693e-03,-9.81675814e-03,-8.51150261e-03,
   5.20274280e-04,-6.47612570e-03,-4.50090293e-03, 5.67651648e-03,
  -1.05803254e-02, 8.29248608e-03, 6.87243833e-03,-2.49706906e-03,
   5.38748762e-03,-4.96502159e-02,-3.77471937e-01,-7.46624036e-02,
  -6.83118859e-05,-3.81345114e-03,-1.55952508e-03, 5.89778623e-03,
  -3.78236218e-03, 5.47381773e-03, 4.49838568e-03, 4.88142006e-03,
   2.98277842e-03, 1.08429943e-02, 1.95857925e-03,-3.98485570e-03,
   1.28231045e-03],
 [ 1.42340498e-02,-8.81380255e-03,-1.54040060e-03,-1.06000903e-03,
  -3.97841766e-03, 1.29896560e-03, 1.74158264e-01, 4.92354446e-01,
   1.99699697e-01, 1.41036137e-02,-4.63823451e-04,-1.20413865e-02,
  -2.94281840e-03,-1.22106317e-02, 1.67936411e-02,-7.32954749e-03,
  -5.93530625e-03, 3.59372893e-03, 1.06305095e-02, 5.91406553e-03,
  -2.49857517e-03, 2.57668595e-03,-4.67245458e-03,-2.58718181e-03,
   5.69977507e-03,-2.64001660e-03,-7.63309988e-02,-3.85191031e-01,
  -6.88862043e-02, 3.31525709e-05, 2.43597513e-03, 2.77295737e-05,
   6.03981742e-03, 8.89162350e-03, 8.57584476e-03, 1.55179617e-03,
   5.25873357e-03, 9.08336319e-03, 2.24888427e-04, 9.32201864e-04,
   1.44744943e-02],
 [ 9.72051510e-03, 1.37805470e-03, 5.35562259e-03,-1.07860286e-02,
  -6.32956327e-04,-8.62602227e-03,-8.25957692e-04, 2.02427568e-01,
   5.12994430e-01, 2.03933888e-01, 1.95496944e-03,-2.14154042e-03,
  -3.24472838e-03, 8.81563646e-03, 9.95995264e-03,-2.17572160e-03,
  -2.06662463e-03, 1.25524742e-02,-4.67622659e-03, 1.33901741e-02,
   1.54447086e-02, 9.98348986e-03, 1.04095178e-03, 9.03673034e-03,
   8.70225117e-03, 5.04967890e-03, 6.75923975e-03,-6.43376583e-02,
  -3.77251917e-01,-6.99632159e-02, 5.26024266e-03,-2.83901797e-03,
   3.69972666e-03,-6.78329694e-03,-3.93143584e-03, 1.35306537e-03,
   1.87333271e-02, 1.09399643e-02,-1.26362514e-03, 6.82023701e-03,
   1.85048948e-02],
 [-6.58389288e-03,-7.31462931e-03,-6.21508028e-03,-1.22257843e-02,
  -4.42414298e-03,-1.44349107e-02,-6.69666448e-03, 8.32295200e-03,
   2.09209816e-01, 5.12267886e-01, 1.99450296e-01, 1.98158801e-03,
   1.36157008e-02,-7.70789930e-03, 9.05577319e-03, 7.88451249e-03,
   3.17271085e-03, 7.41553655e-03, 1.14156724e-03, 7.25176572e-03,
  -1.75575018e-02, 5.36270374e-03, 3.06825591e-04, 1.33641684e-02,
   1.24186786e-03, 9.34818656e-03, 9.06639718e-03, 4.11703776e-03,
  -6.26506735e-02,-3.70106768e-01,-6.16597259e-02,-1.51126581e-03,
   1.45140403e-03,-3.50291775e-03, 1.55129973e-02, 9.83906648e-03,
   2.40632398e-02, 9.58427938e-03, 1.24520999e-03, 1.48464956e-02,
   1.65545448e-02],
 [ 2.71647091e-03,-7.65607264e-03, 5.17343534e-04, 3.04130949e-05,
  -5.71907122e-03, 9.23769533e-03, 3.26333808e-03, 5.42161327e-04,
   4.41783330e-03, 1.99155423e-01, 4.93443704e-01, 2.01481701e-01,
   2.30583697e-03,-4.92787887e-03, 9.69500038e-03, 2.75690297e-03,
  -8.21510109e-03, 7.52801585e-03,-1.72998917e-03,-1.07810430e-02,
  -6.50643067e-03, 4.43230600e-03,-9.10401115e-03, 3.54423828e-03,
  -8.66350390e-03, 1.01430806e-03, 4.35591726e-03, 9.35197669e-03,
   2.65251267e-03,-6.66220138e-02,-3.83189739e-01,-7.07248349e-02,
   5.30536895e-03, 6.27316310e-03, 1.39679052e-02, 5.96254310e-03,
  -6.62550564e-05, 5.24356117e-04, 1.26919777e-02, 1.82403291e-02,
  -4.70273365e-03],
 [-8.03374035e-03,-7.96336084e-04,-2.37502098e-04, 1.11843056e-02,
   5.26423888e-03, 5.10029772e-04,-2.83471620e-03,-1.00656638e-02,
   5.42261146e-03, 1.10627947e-02, 2.02224609e-01, 5.17166587e-01,
   1.96491523e-01, 5.50504245e-03,-2.33117286e-03,-1.40638110e-02,
  -7.17620694e-03,-1.73542392e-03, 2.08272971e-03,-1.46442771e-02,
  -3.06659696e-03,-1.49111431e-02,-9.33237785e-03,-1.00358097e-02,
   3.67137753e-03, 5.31046658e-03, 6.50818201e-04, 4.85764041e-03,
   3.22687811e-03, 1.09014023e-03,-5.69516265e-02,-3.67604707e-01,
  -5.67569929e-02,-1.77976043e-02, 2.05121937e-02,-9.76722590e-03,
   3.25579011e-03, 1.50261333e-02, 1.92819985e-04, 1.80122124e-02,
  -7.88458454e-05],
 [ 1.35926040e-03,-5.65486558e-04, 4.40282259e-03, 8.34570199e-03,
  -1.46798258e-04,-4.49582931e-03, 2.92357276e-03, 5.53965068e-03,
   3.05376481e-03, 1.07661405e-03, 1.37918970e-02, 1.96404571e-01,
   5.04719323e-01, 1.99152334e-01,-1.62371856e-03, 1.54469574e-03,
   1.85169836e-03, 9.20513270e-03,-4.08073410e-03,-6.54982181e-05,
   1.64666884e-02, 3.37296833e-03, 5.90991754e-03,-4.40822405e-03,
   2.21097674e-03, 3.60027831e-03,-7.47532491e-04,-5.45880074e-03,
   1.32217212e-02, 4.07905838e-03,-6.94211269e-03,-5.89877905e-02,
  -3.79429579e-01,-7.65116357e-02, 1.45265725e-02, 1.25986647e-02,
   1.32062584e-02, 1.24978399e-02, 1.09527910e-02, 1.48897208e-02,
   1.94476341e-02],
 [-1.30429841e-02,-1.61661170e-02, 3.63405142e-03, 2.48151168e-03,
  -6.61162450e-03, 1.15882842e-03, 2.61665101e-03, 8.09662665e-03,
  -1.55060607e-02, 5.91313169e-03,-6.30691763e-03,-4.09017684e-03,
   1.98208270e-01, 4.86796889e-01, 1.95763157e-01,-1.23428784e-04,
  -2.07362372e-02, 9.45276486e-03,-9.00682119e-03, 1.14244911e-02,
  -5.22602381e-03, 9.38852796e-03, 5.69344278e-04,-6.07950022e-04,
   1.07505538e-02, 3.61770516e-03, 4.74407769e-03, 4.43673126e-03,
   9.01793492e-03, 6.36105489e-03,-3.98506004e-03,-8.58577657e-05,
  -5.34989283e-02,-3.68435716e-01,-5.35586257e-02, 8.76624111e-03,
   4.46221383e-03, 3.80419866e-03, 8.44411036e-04, 1.47901894e-02,
   7.93499707e-03],
 [-1.60699356e-02, 5.60688980e-04, 1.18465250e-02, 4.21440244e-03,
  -4.03711504e-03, 1.86268973e-03, 8.84455771e-03, 1.07524906e-02,
   5.39161762e-03, 1.59438558e-02, 1.46816745e-02, 2.83969422e-03,
   1.10936075e-03, 2.01121483e-01, 5.00497045e-01, 1.99504367e-01,
  -2.10003017e-03, 3.45577954e-03,-1.21609397e-03,-9.02372584e-04,
   1.20406550e-02, 7.35464298e-03, 6.53619465e-04, 6.00184424e-03,
  -2.04985022e-03,-5.20505356e-03,-4.41231536e-03, 9.88280692e-03,
  -5.75294097e-03,-1.39631934e-03, 1.31014823e-02, 5.85125393e-03,
   1.62594493e-03,-7.13434301e-02,-3.82248574e-01,-6.38877839e-02,
   8.04912282e-03,-3.47059331e-03, 3.81044227e-03, 2.02944013e-02,
  -5.68893933e-03],
 [ 5.71049223e-03, 3.42909845e-03, 4.13994293e-03,-2.94235463e-02,
  -7.84821668e-03,-4.90557213e-03,-1.36545168e-02,-2.76264967e-03,
  -3.41846418e-03, 1.12061507e-02,-8.46809563e-03, 1.88033384e-03,
  -2.90498014e-03,-3.07350928e-03, 1.94898528e-01, 4.89138811e-01,
   1.98844800e-01, 3.09422291e-03,-1.69172933e-02,-5.93796531e-03,
   9.15798975e-03, 9.03593585e-03, 1.00667603e-02, 1.00043854e-02,
   2.21856443e-03,-7.22413133e-04,-2.91485491e-03,-1.49863746e-03,
  -5.04099052e-03, 4.58035910e-04, 8.37749337e-03, 2.46878036e-03,
   2.56457343e-03,-1.91252967e-02,-6.77901573e-02,-3.80510519e-01,
  -5.86986949e-02, 2.20604032e-04, 3.62721715e-03, 2.56926974e-02,
  -9.78558181e-03],
 [ 4.87326381e-03, 2.00219024e-03, 6.46364434e-03, 7.56433552e-04,
  -1.23931343e-02,-2.73827870e-03, 3.59484980e-03,-1.08718355e-03,
   1.05882299e-02, 9.15817401e-03,-4.81840802e-03,-9.03200799e-03,
   4.07669262e-03, 6.77374983e-03,-3.67757218e-03, 1.95853193e-01,
   5.00949231e-01, 2.04392792e-01,-1.07580530e-02,-1.44137561e-03,
   1.20598541e-02, 1.37792205e-02, 7.01197390e-03, 6.20592604e-03,
   2.23312165e-03, 8.47832707e-03,-6.38071640e-03,-8.64288157e-04,
   1.37407381e-02,-3.11558979e-04,-3.76962637e-03,-1.28402568e-02,
   1.48077222e-02, 8.65446452e-03, 8.60820524e-03,-7.59025772e-02,
  -3.80820922e-01,-5.90536016e-02, 1.36325654e-02, 8.66592583e-03,
  -7.87317356e-03],
 [ 4.46181622e-03,-1.18299444e-02,-6.72999089e-03,-4.25508232e-04,
   2.80003339e-03,-5.10013272e-03, 5.10102825e-03,-4.48377326e-03,
   1.24940955e-02, 1.88549975e-02,-8.16814679e-03, 2.88792839e-03,
   3.08830853e-03, 8.23651816e-03,-2.17191479e-03, 3.13020286e-03,
   2.11991398e-01, 4.97569379e-01, 2.06984185e-01,-4.21434044e-03,
   9.64073044e-03, 6.03276227e-03, 7.40687845e-03,-4.03876679e-03,
   9.54919787e-03, 2.24615959e-03,-4.93884208e-04,-8.32512278e-03,
   5.35187933e-03, 1.94095577e-03,-4.10592520e-03, 6.06103958e-03,
  -1.90886026e-04, 7.12406561e-03, 2.00369216e-02,-1.80415264e-03,
  -5.76911428e-02,-3.66785109e-01,-5.32146922e-02, 1.19196549e-02,
  -9.38803706e-03],
 [-5.17582608e-03, 1.09696482e-02,-7.82978595e-03, 4.26359194e-03,
   9.32478528e-03, 1.04362594e-02, 4.21938417e-03,-6.32343963e-03,
   4.17649968e-03, 1.65325345e-03, 1.59199506e-02, 2.61401434e-03,
  -3.85479846e-03, 1.17373402e-03,-4.06566215e-03, 4.13326610e-03,
   1.80290593e-03, 1.83758485e-01, 5.06071455e-01, 1.94828234e-01,
  -6.02360402e-03, 9.62247941e-03, 3.05104369e-03, 9.98164059e-03,
   1.01727644e-02, 9.55800348e-03,-1.28667013e-03, 4.16198975e-03,
   1.00175172e-02, 1.10135671e-02, 1.17556492e-02, 7.63976977e-03,
  -2.61908220e-03, 3.57049712e-03, 1.06232665e-02, 9.94037462e-03,
   8.79335016e-03,-5.91499716e-02,-3.75243401e-01,-6.06180339e-02,
  -7.80425334e-03],
 [ 1.60895677e-02, 8.58555419e-03,-1.37849698e-02,-4.41428388e-03,
   5.98670283e-04,-1.72878728e-04, 3.69025733e-03,-3.15821664e-03,
  -5.58923110e-03, 1.13110803e-03, 8.13695834e-03, 1.86166013e-03,
   6.19034944e-03, 5.89984448e-03,-1.69470652e-02, 8.19044600e-03,
  -3.73940933e-03,-1.58867434e-02, 2.12243481e-01, 5.25716357e-01,
   1.99854666e-01, 2.57697931e-03, 5.22524672e-03, 1.84253400e-02,
   1.30478498e-02, 1.10814871e-02,-1.06071700e-02, 5.39393544e-03,
   6.75877250e-04, 9.56061877e-03, 2.35201875e-02, 3.18268715e-03,
   6.49518800e-03, 3.88080282e-03, 1.03681921e-02, 6.93821555e-03,
   1.84644808e-02,-1.55829824e-04,-6.42981753e-02,-3.84552525e-01,
  -6.73326120e-02],
 [-9.50107310e-03, 1.56729954e-02, 8.10327049e-03, 2.25341896e-04,
   8.59571881e-03, 4.63317453e-03,-4.03286140e-03,-7.10630501e-03,
  -2.87208879e-03,-6.22083575e-03, 3.73189350e-03, 3.56349586e-03,
   1.11699128e-03, 8.75893234e-03,-6.62119188e-03,-5.99383820e-03,
   3.61068136e-03,-1.11189365e-02,-7.21600541e-03, 2.05691451e-01,
   5.03647550e-01, 1.01863711e-02, 1.46405276e-02, 1.03637353e-02,
  -5.41243205e-03, 9.86516474e-03, 9.71949221e-03, 4.41247197e-03,
   2.09836438e-03, 3.66905092e-03, 1.08692850e-02, 1.26006818e-02,
   1.38057419e-02,-8.16230052e-03, 3.14472534e-03,-3.57202711e-03,
   1.23834252e-02, 9.43846173e-03,-9.52443943e-03,-7.52134792e-02,
  -3.74385247e-01]])
    

        # Initialize the start observation
        self._old_ob = np.array(10 * np.ones(self.dimension))
        self._current_step = 0
        self._done = False

    def action_spec(self):
        return self.action_space

    def observation_spec(self):
        return self.observation_space

    def _reset(self):
        self._current_step = 0
        self._old_ob = np.array(10 * np.ones(self.dimension))
        self._done = False

        return self._old_ob.copy()

    def _step(self, action):
        action = np.clip(action, -1., 1.)

        # decide whether to reset the model
        if self._done:
            self._reset()
        feature = np.hstack(([1],self._old_ob,action))
        # get the observation
        ob = np.dot(self.transition, feature) + np.random.multivariate_normal(mean=self.mean, cov=self.identity)

        # get the reward
        reward = self.reward(
            {'end_state': ob, 'start_state': self._old_ob, 'action': action}
        )

        # get the end signal
        self._current_step += 1

        info = {}
        info['reward'] = reward
        info['current_step'] = self._current_step

        if self._current_step >= self._env_info['max_length']:
            done = True
            self._done = True
        else:
            done = False
            self._done = False

        self._old_ob = ob.copy()
        return ob, reward, done, info

    def reward(self, data_dict):
        # TODO: Change the reward like let the reward be small
        return -0.05 * (np.linalg.norm(data_dict['start_state']) ** 2)


# env_name = 'IVVI'
# environment = env(env_name, 123, {'reset_type': 'gym'})
# tf_env = tf_py_environment.TFPyEnvironment(environment)
# print(isinstance(tf_env, tf_environment.TFEnvironment))
# print("TimeStep Specs:", tf_env.time_step_spec())
# print("Action Specs:", tf_env.action_spec())




